{% extends "base.html" %}

{% block title %}{{ agent.name }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin_agents') }}">Agents</a></li>
                    <li class="breadcrumb-item active">{{ agent.name }}</li>
                </ol>
            </nav>
            <h4 class="mb-0">
                <i class="bi bi-robot me-2"></i>{{ agent.name }}
                <span class="badge bg-{{ 'success' if agent.status == 'published' else 'secondary' }} ms-2">
                    {{ agent.status|replace('_', ' ')|title }}
                </span>
            </h4>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('agent_designer', agent_id=agent.agent_id) }}" class="btn btn-primary">
                <i class="bi bi-pencil me-1"></i> Edit in Designer
            </a>
            <a href="{{ url_for('test_agent', agent_id=agent.agent_id) }}" class="btn btn-success">
                <i class="bi bi-play me-1"></i> Test
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Info -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Agent Details</h6>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th width="150">Agent ID</th>
                            <td><code>{{ agent.agent_id }}</code></td>
                        </tr>
                        <tr>
                            <th>Description</th>
                            <td>{{ agent.description or 'No description' }}</td>
                        </tr>
                        <tr>
                            <th>Type</th>
                            <td><span class="badge bg-info">{{ agent.agent_type }}</span></td>
                        </tr>
                        <tr>
                            <th>Version</th>
                            <td>{{ agent.version }}</td>
                        </tr>
                        <tr>
                            <th>Created By</th>
                            <td>{{ agent.created_by }}</td>
                        </tr>
                        <tr>
                            <th>Created At</th>
                            <td>{{ agent.created_at }}</td>
                        </tr>
                        <tr>
                            <th>Updated At</th>
                            <td>{{ agent.updated_at }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <!-- Workflow Preview -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Workflow</h6>
                </div>
                <div class="card-body">
                    {% if agent.workflow and agent.workflow.nodes %}
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        {% for node in agent.workflow.nodes %}
                        <div class="badge bg-primary p-2">
                            <i class="bi bi-circle me-1"></i>{{ node.name }}
                        </div>
                        {% endfor %}
                    </div>
                    <p class="text-muted small mb-0">
                        {{ agent.workflow.nodes|length }} nodes, 
                        {{ agent.workflow.edges|length if agent.workflow.edges else 0 }} connections
                    </p>
                    {% else %}
                    <p class="text-muted mb-0">No workflow defined. 
                        <a href="{{ url_for('agent_designer', agent_id=agent.agent_id) }}">Open Designer</a>
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- LLM Configuration -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-cpu me-2"></i>LLM Configuration</h6>
                </div>
                <div class="card-body">
                    {% if agent.llm_config %}
                    <pre class="json-viewer mb-0">{{ agent.llm_config | tojson(indent=2) }}</pre>
                    {% else %}
                    <p class="text-muted mb-0">No LLM configuration</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <!-- Tools -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-tools me-2"></i>Tools</h6>
                </div>
                <div class="card-body">
                    {% if agent.tools %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for tool in agent.tools %}
                        <span class="badge bg-warning text-dark">{{ tool }}</span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No tools configured</p>
                    {% endif %}
                </div>
            </div>

            <!-- Tags -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-tags me-2"></i>Tags</h6>
                </div>
                <div class="card-body">
                    {% if agent.tags %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for tag in agent.tags %}
                        <span class="badge bg-secondary">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No tags</p>
                    {% endif %}
                </div>
            </div>

            <!-- Status Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-gear me-2"></i>Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if agent.status == 'draft' %}
                        <button class="btn btn-outline-warning" onclick="changeStatus('testing')">
                            <i class="bi bi-flask me-1"></i> Move to Testing
                        </button>
                        {% elif agent.status == 'testing' %}
                        <button class="btn btn-outline-info" onclick="changeStatus('pending_review')">
                            <i class="bi bi-eye me-1"></i> Submit for Review
                        </button>
                        {% elif agent.status == 'approved' %}
                        <button class="btn btn-outline-success" onclick="changeStatus('published')">
                            <i class="bi bi-check-circle me-1"></i> Publish
                        </button>
                        {% elif agent.status == 'published' %}
                        <button class="btn btn-outline-warning" onclick="changeStatus('deprecated')">
                            <i class="bi bi-archive me-1"></i> Deprecate
                        </button>
                        {% endif %}
                        <button class="btn btn-outline-danger" onclick="deleteAgent()">
                            <i class="bi bi-trash me-1"></i> Delete Agent
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function changeStatus(newStatus) {
    if (!confirm(`Change agent status to "${newStatus}"?`)) return;
    
    $.ajax({
        url: `/api/agents/{{ agent.agent_id }}/status`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ status: newStatus }),
        success: function(response) {
            showToast('Status updated successfully', 'success');
            location.reload();
        },
        error: function(xhr) {
            showToast('Error: ' + (xhr.responseJSON?.error || 'Failed to update status'), 'error');
        }
    });
}

function deleteAgent() {
    if (!confirm('Are you sure you want to delete this agent? This cannot be undone.')) return;
    
    $.ajax({
        url: `/api/agents/{{ agent.agent_id }}`,
        method: 'DELETE',
        success: function() {
            window.location.href = '{{ url_for("admin_agents") }}';
        },
        error: function(xhr) {
            showToast('Error deleting agent', 'error');
        }
    });
}
</script>
{% endblock %}

{% block page_glossary %}
<div class="container-fluid py-4 bg-light border-top">
    <div class="row">
        <div class="col-12">
            <h6 class="text-muted mb-3"><i class="bi bi-book me-2"></i>Key Terms on This Page</h6>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">Agent</strong>
                            <p class="small text-muted mb-0">An autonomous AI entity combining LLMs with tools to perform tasks.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">System Prompt</strong>
                            <p class="small text-muted mb-0">Instructions defining the agent's role, behavior, and constraints.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">Tools</strong>
                            <p class="small text-muted mb-0">Functions the agent can use to perform actions.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">LLM Configuration</strong>
                            <p class="small text-muted mb-0">Settings for the language model (provider, model, temperature).</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">Published</strong>
                            <p class="small text-muted mb-0">Agent status indicating it's available for production use.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">Visual Designer</strong>
                            <p class="small text-muted mb-0">Drag-and-drop interface for creating agent workflows.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <a href="{{ url_for('help_page', page='glossary') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-book me-1"></i>View Full Glossary
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
