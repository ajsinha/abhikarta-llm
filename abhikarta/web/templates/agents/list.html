{% extends "base.html" %}

{% block title %}Agent Management - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">
                <i class="bi bi-robot me-2"></i>Agent Management
            </h4>
            <p class="text-muted mb-0">Create, configure, and manage AI agents</p>
        </div>
        <div class="btn-group">
            <a href="{{ url_for('agent_templates') }}" class="btn btn-outline-primary">
                <i class="bi bi-collection me-1"></i> Templates
            </a>
            <a href="{{ url_for('new_agent_designer') }}" class="btn btn-outline-success">
                <i class="bi bi-diagram-3 me-1"></i> Visual Designer
            </a>
            <a href="{{ url_for('agent_create') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i> Create Agent
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-2">
            <div class="card bg-primary text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 small mb-1">Total</h6>
                            <h4 class="mb-0">{{ stats.total }}</h4>
                        </div>
                        <i class="bi bi-robot fs-3 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <a href="?status=pending_review" class="text-decoration-none">
                <div class="card bg-danger text-white">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 small mb-1">Pending Review</h6>
                                <h4 class="mb-0">{{ stats.by_status.pending_review|default(0) }}</h4>
                            </div>
                            <i class="bi bi-hourglass-split fs-3 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-2">
            <a href="?status=approved" class="text-decoration-none">
                <div class="card bg-info text-white">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 small mb-1">Approved</h6>
                                <h4 class="mb-0">{{ stats.by_status.approved|default(0) }}</h4>
                            </div>
                            <i class="bi bi-check-lg fs-3 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-2">
            <a href="?status=published" class="text-decoration-none">
                <div class="card bg-success text-white">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 small mb-1">Published</h6>
                                <h4 class="mb-0">{{ stats.published }}</h4>
                            </div>
                            <i class="bi bi-globe fs-3 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-2">
            <a href="?status=draft" class="text-decoration-none">
                <div class="card bg-warning text-dark">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="opacity-75 small mb-1">Draft</h6>
                                <h4 class="mb-0">{{ stats.draft }}</h4>
                            </div>
                            <i class="bi bi-pencil fs-3 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-2">
            <a href="?status=testing" class="text-decoration-none">
                <div class="card bg-secondary text-white">
                    <div class="card-body py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-white-50 small mb-1">Testing</h6>
                                <h4 class="mb-0">{{ stats.by_status.testing|default(0) }}</h4>
                            </div>
                            <i class="bi bi-flask fs-3 opacity-50"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Filter Active Indicator -->
    {% if status_filter %}
    <div class="alert alert-info d-flex justify-content-between align-items-center mb-4">
        <div>
            <i class="bi bi-funnel me-2"></i>
            Showing agents with status: <strong>{{ status_filter|replace('_', ' ')|title }}</strong>
        </div>
        <a href="{{ url_for('admin_agents') }}" class="btn btn-sm btn-outline-info">
            <i class="bi bi-x me-1"></i>Clear Filter
        </a>
    </div>
    {% endif %}

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="agent-search" placeholder="Search agents...">
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="status-filter" onchange="filterByStatus(this.value)">
                        <option value="">All Status</option>
                        <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>Draft</option>
                        <option value="testing" {% if status_filter == 'testing' %}selected{% endif %}>Testing</option>
                        <option value="pending_review" {% if status_filter == 'pending_review' %}selected{% endif %}>Pending Review</option>
                        <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
                        <option value="published" {% if status_filter == 'published' %}selected{% endif %}>Published</option>
                        <option value="deprecated" {% if status_filter == 'deprecated' %}selected{% endif %}>Deprecated</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="type-filter">
                        <option value="">All Types</option>
                        {% for type in agent_types %}
                        <option value="{{ type.value }}">{{ type.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="sort-filter">
                        <option value="updated_desc">Recently Updated</option>
                        <option value="created_desc">Recently Created</option>
                        <option value="name_asc">Name A-Z</option>
                        <option value="name_desc">Name Z-A</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i class="bi bi-x-circle me-1"></i> Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agents Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="agents-table">
                    <thead>
                        <tr>
                            <th>Agent</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created By</th>
                            <th>Last Updated</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for agent in agents %}
                        <tr>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm bg-primary rounded-circle me-3 d-flex align-items-center justify-content-center">
                                        <i class="bi bi-robot text-white"></i>
                                    </div>
                                    <div>
                                        <strong>{{ agent.name }}</strong>
                                        <br>
                                        <small class="text-muted">{{ agent.agent_id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info">{{ agent.agent_type }}</span>
                            </td>
                            <td>
                                {% set status_colors = {
                                    'draft': 'secondary',
                                    'testing': 'warning',
                                    'pending_review': 'info',
                                    'approved': 'primary',
                                    'published': 'success',
                                    'deprecated': 'danger',
                                    'archived': 'dark'
                                } %}
                                <span class="badge bg-{{ status_colors.get(agent.status, 'secondary') }}">
                                    {{ agent.status|replace('_', ' ')|title }}
                                </span>
                            </td>
                            <td>{{ agent.created_by }}</td>
                            <td>{{ agent.updated_at|datetime('%Y-%m-%d %H:%M') }}</td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <a href="{{ url_for('agent_designer', agent_id=agent.agent_id) }}" 
                                       class="btn btn-outline-primary" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <button class="btn btn-outline-success" 
                                            onclick="testAgent('{{ agent.agent_id }}')" title="Test">
                                        <i class="bi bi-play"></i>
                                    </button>
                                    <button class="btn btn-outline-info" 
                                            onclick="viewAgent('{{ agent.agent_id }}')" title="View">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            onclick="deleteAgent('{{ agent.agent_id }}', '{{ agent.name }}')" title="Delete">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <i class="bi bi-inbox display-4 text-muted"></i>
                                <p class="mt-3 text-muted">No agents found. Create your first agent to get started!</p>
                                <a href="{{ url_for('agent_create') }}" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-1"></i> Create Agent
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Search filter
    $('#agent-search').on('input', filterAgents);
    $('#type-filter').change(filterAgents);
});

function filterByStatus(status) {
    if (status) {
        window.location.href = '{{ url_for("admin_agents") }}?status=' + status;
    } else {
        window.location.href = '{{ url_for("admin_agents") }}';
    }
}

function filterAgents() {
    const search = $('#agent-search').val().toLowerCase();
    const type = $('#type-filter').val();
    
    $('#agents-table tbody tr').each(function() {
        const $row = $(this);
        if ($row.find('td').length < 6) return; // Skip empty row
        
        const name = $row.find('td:first').text().toLowerCase();
        const rowType = $row.find('td:eq(1) .badge').text().toLowerCase();
        
        let visible = true;
        if (search && !name.includes(search)) visible = false;
        if (type && rowType !== type) visible = false;
        
        $row.toggle(visible);
    });
}

function resetFilters() {
    $('#agent-search').val('');
    $('#status-filter').val('');
    $('#type-filter').val('');
    window.location.href = '{{ url_for("admin_agents") }}';
}

function testAgent(agentId) {
    window.location.href = `/agents/${agentId}/test`;
}

function viewAgent(agentId) {
    window.location.href = `/agents/${agentId}`;
}

function deleteAgent(agentId, agentName) {
    if (!confirm(`Are you sure you want to delete "${agentName}"? This action cannot be undone.`)) {
        return;
    }
    
    $.ajax({
        url: `/api/agents/${agentId}`,
        method: 'DELETE',
        success: function() {
            showToast('Agent deleted successfully', 'success');
            location.reload();
        },
        error: function(xhr) {
            showToast('Error deleting agent: ' + xhr.responseJSON?.error, 'error');
        }
    });
}
</script>
{% endblock %}

{% block page_glossary %}
<div class="container-fluid py-4 bg-light border-top">
    <div class="row">
        <div class="col-12">
            <h6 class="text-muted mb-3"><i class="bi bi-book me-2"></i>Key Terms on This Page</h6>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">Agent</strong>
                            <p class="small text-muted mb-0">An autonomous AI entity that combines LLMs with tools to perform complex tasks.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">Agent Type</strong>
                            <p class="small text-muted mb-0">The architectural pattern (ReAct, Chain of Thought, Plan & Execute) defining how an agent reasons.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">Published</strong>
                            <p class="small text-muted mb-0">An agent status indicating it's ready for production use by end users.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">LLM (Large Language Model)</strong>
                            <p class="small text-muted mb-0">An AI model that understands and generates human-like text (e.g., GPT-4, Claude).</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">Visual Designer</strong>
                            <p class="small text-muted mb-0">A drag-and-drop interface for creating agent workflows without coding.</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card h-100 border-0 bg-white">
                        <div class="card-body py-2">
                            <strong class="text-primary">Template</strong>
                            <p class="small text-muted mb-0">A pre-configured agent setup that can be used as a starting point.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center mt-3">
                <a href="{{ url_for('help_page', page='glossary') }}" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-book me-1"></i>View Full Glossary
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}
