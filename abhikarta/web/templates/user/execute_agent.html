{% extends "base.html" %}

{% block title %}Execute {{ agent.name }} - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .execution-container {
        max-width: 900px;
        margin: 0 auto;
    }
    .output-area {
        min-height: 200px;
        max-height: 500px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1rem;
        font-family: 'Courier New', monospace;
    }
    .step-indicator {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    .step-indicator.running {
        background: #fff3cd;
    }
    .step-indicator.completed {
        background: #d1e7dd;
    }
    .step-indicator.failed {
        background: #f8d7da;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="execution-container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-1">
                        <li class="breadcrumb-item"><a href="{{ url_for('user_agents') }}">Agents</a></li>
                        <li class="breadcrumb-item active">{{ agent.name }}</li>
                    </ol>
                </nav>
                <h4 class="mb-0">
                    <i class="bi bi-play-circle me-2"></i>Execute: {{ agent.name }}
                </h4>
            </div>
            <span class="badge bg-{{ agent.agent_type }}">{{ agent.agent_type }}</span>
        </div>

        <!-- Agent Info Card -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h5>{{ agent.name }}</h5>
                        <p class="text-muted mb-2">{{ agent.description }}</p>
                        <div class="d-flex gap-2">
                            <span class="badge bg-info">{{ agent.agent_type }}</span>
                            <span class="badge bg-secondary">v{{ agent.version }}</span>
                            {% for tool in agent.tools[:3] %}
                            <span class="badge bg-warning text-dark">{{ tool }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <small class="text-muted">
                            <i class="bi bi-person me-1"></i>Created by {{ agent.created_by }}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execution Form -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Input</h6>
            </div>
            <div class="card-body">
                <form id="execution-form" method="POST">
                    <div class="mb-3">
                        <label class="form-label">Your Request</label>
                        <textarea class="form-control" name="input" id="user-input" rows="4" 
                                  placeholder="Enter your request or question for the agent..."
                                  required></textarea>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Temperature</label>
                            <input type="range" class="form-range" id="temperature" 
                                   name="temperature" min="0" max="1" step="0.1" value="0.7">
                            <small class="text-muted">Current: <span id="temp-value">0.7</span></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Max Tokens</label>
                            <select class="form-select" name="max_tokens">
                                <option value="1000">1000</option>
                                <option value="2000" selected>2000</option>
                                <option value="4000">4000</option>
                            </select>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg" id="execute-btn">
                            <i class="bi bi-play-fill me-2"></i>Execute Agent
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Output Area -->
        <div class="card" id="output-card" style="display: none;">
            <div class="card-header bg-success text-white d-flex justify-content-between">
                <h6 class="mb-0"><i class="bi bi-terminal me-2"></i>Output</h6>
                <span id="execution-status" class="badge bg-light text-dark">Pending</span>
            </div>
            <div class="card-body">
                <!-- Execution Steps -->
                <div id="execution-steps" class="mb-3"></div>
                
                <!-- Output -->
                <div class="output-area" id="output-content">
                    <span class="text-muted">Waiting for execution...</span>
                </div>
                
                <!-- Actions -->
                <div class="d-flex justify-content-end mt-3 gap-2">
                    <button class="btn btn-outline-secondary" onclick="copyOutput()">
                        <i class="bi bi-clipboard me-1"></i>Copy
                    </button>
                    <button class="btn btn-outline-primary" onclick="clearOutput()">
                        <i class="bi bi-arrow-counterclockwise me-1"></i>New Execution
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    $('#temperature').on('input', function() {
        $('#temp-value').text($(this).val());
    });
    
    $('#execution-form').on('submit', function(e) {
        e.preventDefault();
        executeAgent();
    });
});

function executeAgent() {
    const input = $('#user-input').val();
    if (!input.trim()) {
        alert('Please enter a request');
        return;
    }
    
    // Show output card
    $('#output-card').show();
    $('#execution-status').text('Running').removeClass('bg-light text-dark').addClass('bg-warning text-dark');
    $('#output-content').html('<i class="bi bi-hourglass-split me-2"></i>Processing...');
    $('#execute-btn').prop('disabled', true).html('<i class="bi bi-hourglass-split me-2"></i>Executing...');
    
    // Show execution steps
    $('#execution-steps').html(`
        <div class="step-indicator running">
            <i class="bi bi-arrow-right-circle me-2"></i>
            <span>Initializing agent...</span>
        </div>
    `);
    
    // Simulate execution (replace with actual API call)
    setTimeout(function() {
        $('#execution-steps').append(`
            <div class="step-indicator running">
                <i class="bi bi-cpu me-2"></i>
                <span>Processing with LLM...</span>
            </div>
        `);
    }, 500);
    
    setTimeout(function() {
        $('#execution-steps').append(`
            <div class="step-indicator running">
                <i class="bi bi-tools me-2"></i>
                <span>Executing tools...</span>
            </div>
        `);
    }, 1000);
    
    // Simulate completion
    setTimeout(function() {
        $('#execution-steps .step-indicator').removeClass('running').addClass('completed');
        $('#execution-steps').append(`
            <div class="step-indicator completed">
                <i class="bi bi-check-circle me-2"></i>
                <span>Execution complete</span>
            </div>
        `);
        
        $('#execution-status').text('Completed').removeClass('bg-warning').addClass('bg-success');
        $('#output-content').html(`
            <strong>Agent Response:</strong><br><br>
            Based on your request: "${input.substring(0, 50)}..."<br><br>
            This is a simulated response from the {{ agent.name }} agent. In production, 
            this would contain the actual output from the agent execution pipeline.<br><br>
            <em>Execution ID: exec_${Date.now()}</em>
        `);
        
        $('#execute-btn').prop('disabled', false).html('<i class="bi bi-play-fill me-2"></i>Execute Agent');
    }, 2000);
}

function copyOutput() {
    const output = $('#output-content').text();
    navigator.clipboard.writeText(output).then(function() {
        showToast('Output copied to clipboard', 'success');
    });
}

function clearOutput() {
    $('#output-card').hide();
    $('#user-input').val('');
    $('#execution-steps').empty();
}
</script>
{% endblock %}
