{% extends "base.html" %}

{% block title %}Execution {{ execution.execution_id[:8] }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('user_executions') }}">My Executions</a></li>
                    <li class="breadcrumb-item active">{{ execution.execution_id[:8] }}...</li>
                </ol>
            </nav>
            
            <div class="card mb-4">
                <div class="card-header bg-bmo-blue text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-play-circle me-2"></i>Execution Details</h5>
                    <div>
                        {% if execution.status == 'completed' %}
                        <span class="badge bg-success">Completed</span>
                        {% elif execution.status == 'failed' %}
                        <span class="badge bg-danger">Failed</span>
                        {% elif execution.status == 'running' %}
                        <span class="badge bg-info">Running</span>
                        {% else %}
                        <span class="badge bg-secondary">{{ execution.status }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Execution ID:</strong> <code>{{ execution.execution_id }}</code></p>
                            <p><strong>Type:</strong> {{ execution.execution_type }}</p>
                            {% if execution.agent_id %}
                            <p><strong>Agent:</strong> {{ execution.agent_id }}</p>
                            {% endif %}
                            {% if execution.workflow_id %}
                            <p><strong>Workflow:</strong> {{ execution.workflow_id }}</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <p><strong>Started:</strong> {{ execution.started_at }}</p>
                            <p><strong>Completed:</strong> {{ execution.completed_at or 'In progress' }}</p>
                            <p><strong>Duration:</strong> {{ execution.duration_ms or 0 }} ms</p>
                            <p><strong>Tokens:</strong> {{ execution.total_tokens or 0 }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-box-arrow-in-right me-2"></i>Input</h5>
                        </div>
                        <div class="card-body">
                            <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>{{ execution.input_data | tojson(indent=2) if execution.input_data else 'No input' }}</code></pre>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="bi bi-box-arrow-right me-2"></i>Output</h5>
                        </div>
                        <div class="card-body">
                            <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;"><code>{{ execution.output_data | tojson(indent=2) if execution.output_data else 'No output' }}</code></pre>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if execution.error_message %}
            <div class="card mb-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Error</h5>
                </div>
                <div class="card-body">
                    <pre class="text-danger">{{ execution.error_message }}</pre>
                </div>
            </div>
            {% endif %}
            
            {% if steps %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ol me-2"></i>Execution Steps</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Node</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for step in steps %}
                                <tr>
                                    <td>{{ step.step_number }}</td>
                                    <td><code>{{ step.node_id }}</code></td>
                                    <td><span class="badge bg-secondary">{{ step.node_type }}</span></td>
                                    <td>
                                        {% if step.status == 'completed' %}
                                        <span class="badge bg-success">{{ step.status }}</span>
                                        {% elif step.status == 'failed' %}
                                        <span class="badge bg-danger">{{ step.status }}</span>
                                        {% else %}
                                        <span class="badge bg-info">{{ step.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ step.duration_ms or 0 }} ms</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="mt-4">
                {% if execution.status == 'failed' %}
                <button class="btn btn-warning" onclick="retryExecution('{{ execution.execution_id }}')">
                    <i class="bi bi-arrow-clockwise me-2"></i>Retry Execution
                </button>
                {% endif %}
                <a href="{{ url_for('user_executions') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Executions
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function retryExecution(executionId) {
    if (confirm('Retry this execution with the same input?')) {
        fetch(`/api/executions/${executionId}/retry`, {method: 'POST'})
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Execution retried successfully!');
                    location.reload();
                } else {
                    alert('Error: ' + data.error);
                }
            });
    }
}
</script>
{% endblock %}
