{% extends "base.html" %}

{% block title %}User Management - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">
                <i class="bi bi-people me-2"></i>User Management
            </h4>
            <p class="text-muted mb-0">Manage users, roles, and permissions</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-person-plus me-1"></i> Add User
        </button>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Total Users</h6>
                            <h3 class="mb-0">{{ user_stats.total }}</h3>
                        </div>
                        <i class="bi bi-people display-6 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Active Users</h6>
                            <h3 class="mb-0">{{ user_stats.active }}</h3>
                        </div>
                        <i class="bi bi-person-check display-6 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="opacity-75">Admins</h6>
                            <h3 class="mb-0">{{ user_stats.admins }}</h3>
                        </div>
                        <i class="bi bi-shield-check display-6 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="text-white-50">Total Roles</h6>
                            <h3 class="mb-0">{{ user_stats.roles_count }}</h3>
                        </div>
                        <i class="bi bi-key display-6 opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="user-search" 
                               placeholder="Search users...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="role-filter">
                        <option value="">All Roles</option>
                        <option value="super_admin">Super Admin</option>
                        <option value="domain_admin">Domain Admin</option>
                        <option value="agent_developer">Agent Developer</option>
                        <option value="agent_publisher">Agent Publisher</option>
                        <option value="hitl_reviewer">HITL Reviewer</option>
                        <option value="agent_user">Agent User</option>
                        <option value="viewer">Viewer</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="status-filter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                        <i class="bi bi-x-circle me-1"></i> Reset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Roles</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr data-userid="{{ user.user_id }}" 
                            data-roles="{{ user.roles|join(',') if user.roles else '' }}"
                            data-status="{{ 'active' if user.is_active else 'inactive' }}">
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm bg-primary rounded-circle me-3 d-flex align-items-center justify-content-center" style="width:40px;height:40px;">
                                        <span class="text-white fw-bold">{{ user.fullname[:1]|upper if user.fullname else 'U' }}</span>
                                    </div>
                                    <div>
                                        <strong>{{ user.fullname }}</strong>
                                        <br>
                                        <small class="text-muted">{{ user.user_id }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>{{ user.email or '-' }}</td>
                            <td>
                                {% for role in user.roles %}
                                {% set role_colors = {
                                    'super_admin': 'danger',
                                    'domain_admin': 'warning',
                                    'agent_developer': 'success',
                                    'agent_publisher': 'info',
                                    'hitl_reviewer': 'primary',
                                    'agent_user': 'secondary',
                                    'viewer': 'light'
                                } %}
                                <span class="badge bg-{{ role_colors.get(role, 'secondary') }} me-1">
                                    {{ role|replace('_', ' ')|title }}
                                </span>
                                {% endfor %}
                            </td>
                            <td>
                                {% if user.is_active %}
                                <span class="badge bg-success">Active</span>
                                {% else %}
                                <span class="badge bg-danger">Inactive</span>
                                {% endif %}
                            </td>
                            <td>{{ user.created_at if user.created_at else 'N/A' }}</td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" 
                                            onclick="editUser('{{ user.user_id }}')" title="Edit">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-outline-info" 
                                            onclick="viewUser('{{ user.user_id }}')" title="View">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" 
                                            onclick="resetPassword('{{ user.user_id }}')" title="Reset Password">
                                        <i class="bi bi-key"></i>
                                    </button>
                                    {% if user.user_id != userid %}
                                    <button class="btn btn-outline-{{ 'danger' if user.is_active else 'success' }}" 
                                            onclick="toggleUserStatus('{{ user.user_id }}', {{ 'true' if user.is_active else 'false' }})" 
                                            title="{{ 'Deactivate' if user.is_active else 'Activate' }}">
                                        <i class="bi bi-{{ 'x-circle' if user.is_active else 'check-circle' }}"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <i class="bi bi-people display-4 text-muted"></i>
                                <p class="mt-3 text-muted">No users found</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Add New User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="add-user-form" method="POST" action="{{ url_for('add_user') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">User ID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="user_id" required
                                       pattern="[a-zA-Z0-9_]+" 
                                       title="Only letters, numbers, and underscores"
                                       placeholder="e.g., john_doe">
                                <small class="text-muted">Unique identifier for login</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Full Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="fullname" required
                                       placeholder="e.g., John Doe">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" name="email" required
                                       placeholder="e.g., john@example.com">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Password <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" name="password" required
                                       minlength="6" placeholder="Minimum 6 characters">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Roles <span class="text-danger">*</span></label>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="roles" value="super_admin" id="role-super_admin">
                                    <label class="form-check-label" for="role-super_admin">Super Admin</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="roles" value="domain_admin" id="role-domain_admin">
                                    <label class="form-check-label" for="role-domain_admin">Domain Admin</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="roles" value="agent_developer" id="role-agent_developer">
                                    <label class="form-check-label" for="role-agent_developer">Agent Developer</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="roles" value="agent_publisher" id="role-agent_publisher">
                                    <label class="form-check-label" for="role-agent_publisher">Agent Publisher</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="roles" value="hitl_reviewer" id="role-hitl_reviewer">
                                    <label class="form-check-label" for="role-hitl_reviewer">HITL Reviewer</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="roles" value="agent_user" id="role-agent_user" checked>
                                    <label class="form-check-label" for="role-agent_user">Agent User</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="roles" value="viewer" id="role-viewer">
                                    <label class="form-check-label" for="role-viewer">Viewer</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="is_active" id="is-active" checked>
                        <label class="form-check-label" for="is-active">User is active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-person-plus me-1"></i> Add User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-pencil me-2"></i>Edit User</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="edit-user-form" method="POST" action="{{ url_for('update_user') }}">
                <div class="modal-body" id="edit-user-content">
                    <!-- Dynamic content loaded via JS -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-save me-1"></i> Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View User Modal -->
<div class="modal fade" id="viewUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="bi bi-person me-2"></i>User Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="view-user-content">
                <!-- Dynamic content loaded via JS -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// User data for modals
const usersData = {{ users|tojson|safe if users else '[]' }};

$(document).ready(function() {
    $('#user-search').on('input', filterUsers);
    $('#role-filter, #status-filter').change(filterUsers);
});

function filterUsers() {
    const search = $('#user-search').val().toLowerCase();
    const role = $('#role-filter').val();
    const status = $('#status-filter').val();
    
    $('#users-table tbody tr').each(function() {
        const $row = $(this);
        const name = $row.find('td:first').text().toLowerCase();
        const userRoles = $row.data('roles') || '';
        const userStatus = $row.data('status');
        
        let visible = true;
        if (search && !name.includes(search)) visible = false;
        if (role && !userRoles.includes(role)) visible = false;
        if (status && userStatus !== status) visible = false;
        
        $row.toggle(visible);
    });
}

function resetFilters() {
    $('#user-search').val('');
    $('#role-filter').val('');
    $('#status-filter').val('');
    filterUsers();
}

function editUser(userId) {
    const user = usersData.find(u => u.user_id === userId);
    if (!user) return;
    
    const allRoles = ['super_admin', 'domain_admin', 'agent_developer', 'agent_publisher', 'hitl_reviewer', 'agent_user', 'viewer'];
    const rolesHtml = allRoles.map(role => `
        <div class="col-md-4">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="roles" value="${role}" 
                       id="edit-role-${role}" ${user.roles && user.roles.includes(role) ? 'checked' : ''}>
                <label class="form-check-label" for="edit-role-${role}">
                    ${role.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                </label>
            </div>
        </div>
    `).join('');
    
    const html = `
        <input type="hidden" name="user_id" value="${user.user_id}">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">User ID</label>
                    <input type="text" class="form-control" value="${user.user_id}" readonly>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Full Name <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" name="fullname" value="${user.fullname || ''}" required>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Email <span class="text-danger">*</span></label>
            <input type="email" class="form-control" name="email" value="${user.email || ''}" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Roles</label>
            <div class="row">${rolesHtml}</div>
        </div>
        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="is_active" id="edit-is-active" ${user.is_active ? 'checked' : ''}>
            <label class="form-check-label" for="edit-is-active">User is active</label>
        </div>
    `;
    
    $('#edit-user-content').html(html);
    new bootstrap.Modal('#editUserModal').show();
}

function viewUser(userId) {
    const user = usersData.find(u => u.user_id === userId);
    if (!user) return;
    
    const rolesHtml = (user.roles || []).map(r => 
        `<span class="badge bg-info me-1">${r.replace(/_/g, ' ')}</span>`
    ).join('');
    
    const html = `
        <div class="row">
            <div class="col-md-4 text-center">
                <div class="bg-primary rounded-circle mx-auto mb-3 d-flex align-items-center justify-content-center" 
                     style="width: 100px; height: 100px;">
                    <span class="text-white display-4">${(user.fullname || 'U')[0].toUpperCase()}</span>
                </div>
                <h5>${user.fullname}</h5>
                <p class="text-muted">${user.user_id}</p>
                <span class="badge bg-${user.is_active ? 'success' : 'danger'}">
                    ${user.is_active ? 'Active' : 'Inactive'}
                </span>
            </div>
            <div class="col-md-8">
                <table class="table">
                    <tr><th width="150">Email</th><td>${user.email || '-'}</td></tr>
                    <tr><th>Roles</th><td>${rolesHtml || '-'}</td></tr>
                    <tr><th>Created</th><td>${user.created_at || 'N/A'}</td></tr>
                </table>
            </div>
        </div>
    `;
    
    $('#view-user-content').html(html);
    new bootstrap.Modal('#viewUserModal').show();
}

function resetPassword(userId) {
    if (!confirm(`Reset password for user "${userId}"?`)) return;
    
    $.ajax({
        url: `/api/users/${userId}/reset-password`,
        method: 'POST',
        success: function(response) {
            alert(`New password: ${response.new_password}\n\nPlease share this with the user securely.`);
        },
        error: function(xhr) {
            showToast('Error resetting password', 'error');
        }
    });
}

function toggleUserStatus(userId, currentStatus) {
    const action = currentStatus ? 'deactivate' : 'activate';
    if (!confirm(`Are you sure you want to ${action} this user?`)) return;
    
    $.ajax({
        url: `/api/users/${userId}/toggle-status`,
        method: 'POST',
        success: function() {
            showToast(`User ${action}d successfully`, 'success');
            location.reload();
        },
        error: function(xhr) {
            showToast('Error updating user status', 'error');
        }
    });
}
</script>
{% endblock %}
