{% extends "base.html" %}

{% block title %}Edit MCP Tool Server - {{ server.name }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-server me-2"></i>Edit MCP Tool Server</h2>
            <p class="text-muted mb-0">Modify configuration for {{ server.name }}</p>
        </div>
        <a href="{{ url_for('admin_mcp_tool_servers') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Servers
        </a>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
    
    <div class="row">
        <div class="col-lg-8">
            <form method="POST" action="{{ url_for('edit_mcp_tool_server', server_id=server.server_id) }}">
                <!-- Basic Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Server ID</label>
                            <input type="text" class="form-control" value="{{ server.server_id }}" disabled>
                        </div>
                        
                        <div class="mb-3">
                            <label for="name" class="form-label">Server Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required
                                   value="{{ server.name }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="2">{{ server.description or '' }}</textarea>
                        </div>
                        
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="is_active" name="is_active"
                                   {% if server.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="is_active">Active</label>
                        </div>
                    </div>
                </div>
                
                <!-- Connection Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Connection Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="base_url" class="form-label">Base URL <span class="text-danger">*</span></label>
                            <input type="url" class="form-control" id="base_url" name="base_url" required
                                   value="{{ server.base_url }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="tools_endpoint" class="form-label">Tools Endpoint</label>
                            <input type="text" class="form-control" id="tools_endpoint" name="tools_endpoint" 
                                   value="{{ server.tools_endpoint or '/api/tools/list' }}">
                        </div>
                        
                        <div class="mb-3">
                            <label for="timeout_seconds" class="form-label">Timeout (seconds)</label>
                            <input type="number" class="form-control" id="timeout_seconds" name="timeout_seconds" 
                                   value="{{ server.timeout_seconds or 30 }}" min="5" max="120">
                        </div>
                    </div>
                </div>
                
                <!-- Authentication -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Authentication</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="auth_type" class="form-label">Authentication Type</label>
                            <select class="form-select" id="auth_type" name="auth_type" onchange="toggleAuthConfig()">
                                <option value="none" {% if server.auth_type == 'none' %}selected{% endif %}>None</option>
                                <option value="bearer" {% if server.auth_type == 'bearer' %}selected{% endif %}>Bearer Token</option>
                                <option value="api_key" {% if server.auth_type == 'api_key' %}selected{% endif %}>API Key</option>
                                <option value="basic" {% if server.auth_type == 'basic' %}selected{% endif %}>Basic Auth (with Login Endpoint)</option>
                            </select>
                            <div class="form-text">Select how to authenticate with the MCP server</div>
                        </div>
                        
                        <div id="auth_config_container" class="{% if server.auth_type == 'none' %}d-none{% endif %}">
                            <div class="mb-3">
                                <label for="auth_config" class="form-label">Authentication Configuration (JSON)</label>
                                <textarea class="form-control font-monospace" id="auth_config" name="auth_config" 
                                          rows="5">{{ server.auth_config or '{}' }}</textarea>
                                <div class="form-text" id="auth_help">Configure authentication parameters in JSON format</div>
                            </div>
                        </div>
                        
                        <!-- Auth Endpoint - always visible -->
                        <div class="mb-3">
                            <label for="auth_endpoint" class="form-label">Authentication Endpoint <span class="text-muted">(Optional)</span></label>
                            <input type="text" class="form-control" id="auth_endpoint" name="auth_endpoint" 
                                   value="{{ server.auth_endpoint or '' }}"
                                   placeholder="/api/auth/login">
                            <div class="form-text">
                                Optional if not using Basic Authentication. For Basic Auth, this endpoint will be called 
                                with credentials to obtain a token. Should return JSON with 'token' field or raw token string.
                            </div>
                        </div>
                        
                        <!-- Auth Flow Explanation -->
                        <div id="auth_flow_info" class="{% if server.auth_type == 'none' %}d-none{% endif %}">
                            <div class="alert alert-info small mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                <span id="auth_flow_text">
                                    {% if server.auth_type == 'bearer' %}
                                    Token will be included in all requests to the MCP server.
                                    {% elif server.auth_type == 'api_key' %}
                                    API key will be sent in the specified header for all requests.
                                    {% elif server.auth_type == 'basic' %}
                                    System will call the auth endpoint with credentials. The returned token will be used as Bearer token for all subsequent MCP calls.
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Auto-Refresh Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-arrow-repeat me-2"></i>Auto-Refresh Settings</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="auto_refresh" name="auto_refresh"
                                   {% if server.auto_refresh %}checked{% endif %}>
                            <label class="form-check-label" for="auto_refresh">Enable Auto-Refresh</label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="refresh_interval_minutes" class="form-label">Refresh Interval (minutes)</label>
                            <input type="number" class="form-control" id="refresh_interval_minutes" 
                                   name="refresh_interval_minutes" value="{{ server.refresh_interval_minutes or 60 }}" 
                                   min="5" max="1440">
                        </div>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between">
                    <form method="POST" action="{{ url_for('delete_mcp_tool_server', server_id=server.server_id) }}"
                          onsubmit="return confirm('Are you sure you want to delete this server?');">
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-trash me-2"></i>Delete Server
                        </button>
                    </form>
                    
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('admin_mcp_tool_servers') }}" class="btn btn-outline-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-2"></i>Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Status Sidebar -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 80px;">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-activity me-2"></i>Server Status</h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <small class="text-muted d-block">Tools Loaded</small>
                            <span class="fs-4 fw-bold text-primary">{{ server.tool_count }}</span>
                        </div>
                        <div class="col-6 text-end">
                            <small class="text-muted d-block">Status</small>
                            {% if server.last_refresh_status == 'success' %}
                            <span class="badge bg-success">Healthy</span>
                            {% elif server.last_refresh_status %}
                            <span class="badge bg-danger">Error</span>
                            {% else %}
                            <span class="badge bg-secondary">Unknown</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <hr>
                    
                    <small class="text-muted d-block">Last Refresh</small>
                    <p class="mb-2">{{ server.last_refresh or 'Never' }}</p>
                    
                    {% if server.last_refresh_status and server.last_refresh_status != 'success' %}
                    <small class="text-muted d-block">Last Error</small>
                    <p class="text-danger small mb-2">{{ server.last_refresh_status }}</p>
                    {% endif %}
                    
                    <small class="text-muted d-block">Created</small>
                    <p class="mb-2">{{ server.created_at }}</p>
                    
                    <hr>
                    
                    <form method="POST" action="{{ url_for('refresh_mcp_tool_server', server_id=server.server_id) }}">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-arrow-clockwise me-2"></i>Refresh Tools Now
                        </button>
                    </form>
                    
                    {% if server.tool_count > 0 %}
                    <a href="{{ url_for('view_mcp_server_tools', server_id=server.server_id) }}" 
                       class="btn btn-outline-primary w-100 mt-2">
                        <i class="bi bi-tools me-2"></i>View Tools
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Authentication configuration examples
const authExamples = {
    bearer: {
        config: {"token": "your-bearer-token-here"},
        help: "Enter your bearer token. It will be sent as 'Authorization: Bearer {token}' header.",
        flow: "Token will be included in all requests to the MCP server."
    },
    api_key: {
        config: {"header": "X-API-Key", "key": "your-api-key-here"},
        help: "Specify the header name and your API key value.",
        flow: "API key will be sent in the specified header for all requests."
    },
    basic: {
        config: {"username": "your-username", "password": "your-password"},
        help: "Enter username and password. These will be used to call the auth endpoint.",
        flow: "System will call the auth endpoint with these credentials. The returned token will be used as Bearer token for all subsequent MCP calls."
    }
};

function toggleAuthConfig() {
    const authType = document.getElementById('auth_type').value;
    const container = document.getElementById('auth_config_container');
    const authHelp = document.getElementById('auth_help');
    const authFlowInfo = document.getElementById('auth_flow_info');
    const authFlowText = document.getElementById('auth_flow_text');
    
    if (authType === 'none') {
        container.classList.add('d-none');
        authFlowInfo.classList.add('d-none');
    } else {
        container.classList.remove('d-none');
        authFlowInfo.classList.remove('d-none');
        
        const example = authExamples[authType];
        authHelp.textContent = example.help;
        authFlowText.textContent = example.flow;
        
        // Set default auth endpoint for basic auth if empty
        if (authType === 'basic') {
            const authEndpoint = document.getElementById('auth_endpoint');
            if (!authEndpoint.value) {
                authEndpoint.value = '/api/auth/login';
            }
        }
    }
}
</script>
{% endblock %}
