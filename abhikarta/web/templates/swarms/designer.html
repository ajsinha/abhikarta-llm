{% extends "base.html" %}

{% block title %}Swarm Designer - {{ swarm.name if swarm else 'New Swarm' }} - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
/* ============================================
   DESIGNER LAYOUT
   ============================================ */
.designer-container {
    display: flex;
    height: calc(100vh - 140px);
    gap: 12px;
    padding: 0;
}

/* ============================================
   LEFT SIDEBAR - COMPONENT PALETTE
   ============================================ */
.component-palette {
    width: 280px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
}

.palette-header {
    padding: 15px;
    background: linear-gradient(135deg, #6f42c1 0%, #8b5cf6 100%);
    color: #fff;
    font-weight: 600;
    font-size: 0.95rem;
}

.palette-header i {
    margin-right: 8px;
}

.palette-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
}

.palette-section {
    margin-bottom: 15px;
}

.palette-section-title {
    font-size: 10px;
    font-weight: 700;
    color: #888;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 10px;
    padding-left: 5px;
}

/* Draggable palette items */
.palette-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background: linear-gradient(135deg, #f8f9fa 0%, #fff 100%);
    border: 2px solid #e9ecef;
    border-radius: 10px;
    cursor: grab;
    transition: all 0.2s ease;
    user-select: none;
}

.palette-item:hover {
    border-color: #6f42c1;
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(111, 66, 193, 0.15);
}

.palette-item:active {
    cursor: grabbing;
    transform: translateX(5px) scale(0.98);
}

.palette-item .icon-wrapper {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 18px;
    margin-right: 12px;
    flex-shrink: 0;
}

.palette-item .item-info {
    flex: 1;
    min-width: 0;
}

.palette-item .item-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: #333;
}

.palette-item .item-desc {
    font-size: 0.75rem;
    color: #888;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Drag ghost */
.drag-ghost {
    position: fixed;
    pointer-events: none;
    z-index: 10000;
    opacity: 0.9;
    transform: rotate(-2deg);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

/* ============================================
   MAIN CANVAS AREA
   ============================================ */
.canvas-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

.canvas-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    background: #fff;
    border-radius: 10px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.swarm-name-input {
    font-size: 1.1rem;
    font-weight: 600;
    border: none;
    background: transparent;
    width: 300px;
    padding: 5px 10px;
    border-radius: 5px;
}

.swarm-name-input:focus {
    outline: none;
    background: #f8f9fa;
}

.canvas-wrapper {
    flex: 1;
    background: 
        linear-gradient(90deg, #f0f0f0 1px, transparent 1px),
        linear-gradient(#f0f0f0 1px, transparent 1px);
    background-size: 25px 25px;
    background-color: #fafbfc;
    border-radius: 10px;
    overflow: auto;
    position: relative;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
}

.canvas-wrapper.drag-over {
    background-color: #f0f7ff;
    box-shadow: inset 0 0 0 3px #0d6efd;
}

#design-canvas {
    position: relative;
    width: 2500px;
    height: 1500px;
    min-width: 100%;
    min-height: 100%;
}

/* ============================================
   FIXED ELEMENTS - MASTER ACTOR & EVENT BUS
   ============================================ */
.master-actor {
    position: absolute;
    left: 50%;
    top: 150px;
    transform: translateX(-50%);
    width: 220px;
    background: linear-gradient(135deg, #6f42c1 0%, #9f7aea 100%);
    border-radius: 16px;
    box-shadow: 0 8px 30px rgba(111, 66, 193, 0.35);
    color: #fff;
    text-align: center;
    padding: 20px;
    z-index: 50;
}

.master-actor-icon {
    font-size: 42px;
    margin-bottom: 10px;
}

.master-actor-title {
    font-weight: 700;
    font-size: 1.15rem;
    margin-bottom: 4px;
}

.master-actor-subtitle {
    font-size: 0.85rem;
    opacity: 0.9;
}

.event-bus {
    position: absolute;
    left: 50%;
    top: 320px;
    transform: translateX(-50%);
    width: 700px;
    height: 65px;
    background: linear-gradient(90deg, #0dcaf0 0%, #17a2b8 50%, #0dcaf0 100%);
    border-radius: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 600;
    font-size: 1rem;
    box-shadow: 0 6px 25px rgba(13, 202, 240, 0.35);
    z-index: 40;
}

.event-bus i {
    font-size: 26px;
    margin-right: 12px;
    animation: pulse-icon 2s infinite;
}

@keyframes pulse-icon {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.7; transform: scale(0.95); }
}

/* ============================================
   SVG CONNECTIONS
   ============================================ */
#connections-svg {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
}

.connection-path {
    fill: none;
    stroke-width: 3;
    stroke-linecap: round;
}

.connection-path.trigger-to-master {
    stroke: #ffc107;
    stroke-dasharray: 8, 4;
    animation: dash-flow 1s linear infinite;
}

.connection-path.master-to-bus {
    stroke: #6f42c1;
    stroke-width: 4;
}

.connection-path.bus-to-agent {
    stroke: #17a2b8;
    stroke-dasharray: 8, 4;
    animation: dash-flow 1s linear infinite reverse;
}

@keyframes dash-flow {
    to { stroke-dashoffset: -12; }
}

/* Arrow markers */
.arrow-marker {
    fill: currentColor;
}

/* ============================================
   TRIGGER NODES
   ============================================ */
.trigger-node {
    position: absolute;
    width: 160px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    cursor: move;
    transition: transform 0.15s, box-shadow 0.15s;
    z-index: 60;
    overflow: hidden;
}

.trigger-node:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.trigger-node.selected {
    box-shadow: 0 0 0 3px #6f42c1, 0 8px 25px rgba(0,0,0,0.15);
}

.trigger-node.ui-draggable-dragging {
    z-index: 1000;
    box-shadow: 0 12px 35px rgba(0,0,0,0.2);
}

.trigger-node-header {
    padding: 12px;
    color: #fff;
    font-weight: 600;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.trigger-node-header i {
    font-size: 18px;
}

.trigger-node-body {
    padding: 10px 12px;
    font-size: 0.8rem;
    color: #666;
    border-top: 3px solid currentColor;
    background: #fafafa;
}

/* ============================================
   AGENT NODES
   ============================================ */
.agent-node {
    position: absolute;
    width: 180px;
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.1);
    cursor: move;
    transition: transform 0.15s, box-shadow 0.15s;
    z-index: 60;
    overflow: hidden;
}

.agent-node:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 28px rgba(0,0,0,0.15);
}

.agent-node.selected {
    box-shadow: 0 0 0 3px #6f42c1, 0 8px 28px rgba(0,0,0,0.15);
}

.agent-node.ui-draggable-dragging {
    z-index: 1000;
    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
}

.agent-node-header {
    padding: 14px;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
}

.agent-node-header i {
    font-size: 22px;
}

.agent-node-header .agent-info {
    flex: 1;
}

.agent-node-header .agent-name {
    font-weight: 600;
    font-size: 0.95rem;
}

.agent-node-header .agent-role {
    font-size: 0.75rem;
    opacity: 0.9;
}

.agent-node-body {
    padding: 12px;
    background: #fafafa;
}

.agent-subscription-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 8px;
    background: #e9ecef;
    border-radius: 4px;
    font-size: 0.75rem;
    color: #555;
    margin: 2px;
}

.agent-subscription-tag i {
    font-size: 10px;
    color: #ffc107;
}

.agent-pool-info {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #eee;
    font-size: 0.75rem;
    color: #888;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* ============================================
   RIGHT SIDEBAR - PROPERTIES PANEL
   ============================================ */
.properties-panel {
    width: 300px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
}

.properties-header {
    padding: 15px;
    background: linear-gradient(135deg, #0d6efd 0%, #0dcaf0 100%);
    color: #fff;
    font-weight: 600;
    font-size: 0.95rem;
}

.properties-header i {
    margin-right: 8px;
}

.properties-body {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
}

.prop-group {
    margin-bottom: 15px;
}

.prop-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: #555;
    margin-bottom: 6px;
}

.prop-input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.prop-input:focus {
    outline: none;
    border-color: #6f42c1;
    box-shadow: 0 0 0 3px rgba(111, 66, 193, 0.1);
}

.prop-input:disabled {
    background: #f5f5f5;
    color: #888;
}

.prop-hint {
    font-size: 0.75rem;
    color: #999;
    margin-top: 4px;
}

/* ============================================
   TOAST NOTIFICATIONS
   ============================================ */
.toast-container {
    z-index: 9999;
}
</style>
{% endblock %}

{% block content %}
<div class="designer-container">
    <!-- LEFT: Component Palette -->
    <div class="component-palette">
        <div class="palette-header">
            <i class="bi bi-grid-3x3-gap-fill"></i>Components
        </div>
        <div class="palette-body">
            <!-- Triggers Section -->
            <div class="palette-section">
                <div class="palette-section-title">External Triggers</div>
                
                <div class="palette-item" data-type="trigger" data-trigger-type="kafka">
                    <div class="icon-wrapper" style="background: #231f20;">
                        <i class="bi bi-broadcast"></i>
                    </div>
                    <div class="item-info">
                        <div class="item-name">Kafka</div>
                        <div class="item-desc">Message queue trigger</div>
                    </div>
                </div>
                
                <div class="palette-item" data-type="trigger" data-trigger-type="rabbitmq">
                    <div class="icon-wrapper" style="background: #ff6600;">
                        <i class="bi bi-envelope-fill"></i>
                    </div>
                    <div class="item-info">
                        <div class="item-name">RabbitMQ</div>
                        <div class="item-desc">AMQP queue trigger</div>
                    </div>
                </div>
                
                <div class="palette-item" data-type="trigger" data-trigger-type="schedule">
                    <div class="icon-wrapper" style="background: #fd7e14;">
                        <i class="bi bi-clock-fill"></i>
                    </div>
                    <div class="item-info">
                        <div class="item-name">Schedule</div>
                        <div class="item-desc">Cron-based trigger</div>
                    </div>
                </div>
                
                <div class="palette-item" data-type="trigger" data-trigger-type="http">
                    <div class="icon-wrapper" style="background: #198754;">
                        <i class="bi bi-globe"></i>
                    </div>
                    <div class="item-info">
                        <div class="item-name">HTTP Webhook</div>
                        <div class="item-desc">REST API trigger</div>
                    </div>
                </div>
                
                <div class="palette-item" data-type="trigger" data-trigger-type="user_query">
                    <div class="icon-wrapper" style="background: #0d6efd;">
                        <i class="bi bi-chat-dots-fill"></i>
                    </div>
                    <div class="item-info">
                        <div class="item-name">User Query</div>
                        <div class="item-desc">Direct user input</div>
                    </div>
                </div>
            </div>
            
            <!-- Agents Section -->
            <div class="palette-section">
                <div class="palette-section-title">Available Agents</div>
                
                {% for agent in agents %}
                <div class="palette-item" data-type="agent" data-agent-id="{{ agent.agent_id }}" data-agent-name="{{ agent.name }}">
                    <div class="icon-wrapper" style="background: #0d6efd;">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="item-info">
                        <div class="item-name">{{ agent.name }}</div>
                        <div class="item-desc">{{ (agent.description or 'AI Agent')[:25] }}...</div>
                    </div>
                </div>
                {% else %}
                <div class="text-muted small text-center py-3">
                    <i class="bi bi-info-circle me-1"></i>
                    No agents available.<br>
                    <a href="{{ url_for('agent_create') }}">Create an agent</a> first.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- CENTER: Canvas Area -->
    <div class="canvas-container">
        <div class="canvas-toolbar">
            <div class="d-flex align-items-center">
                <input type="text" class="swarm-name-input" id="swarm-name" 
                       value="{{ swarm.name if swarm else 'New Swarm' }}" 
                       placeholder="Swarm Name">
                <span class="badge bg-secondary ms-2" id="status-badge">{{ swarm.status if swarm else 'draft' }}</span>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="centerCanvas()">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
                <button class="btn btn-primary btn-sm" onclick="saveSwarm()">
                    <i class="bi bi-save me-1"></i>Save Swarm
                </button>
                <a href="{{ url_for('list_swarms') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-x-lg me-1"></i>Close
                </a>
            </div>
        </div>
        
        <div class="canvas-wrapper" id="canvas-wrapper">
            <div id="design-canvas">
                <!-- SVG Layer for Connections -->
                <svg id="connections-svg">
                    <defs>
                        <marker id="arrow-yellow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#ffc107"/>
                        </marker>
                        <marker id="arrow-purple" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#6f42c1"/>
                        </marker>
                        <marker id="arrow-cyan" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#17a2b8"/>
                        </marker>
                    </defs>
                </svg>
                
                <!-- Master Actor (Fixed Position) -->
                <div class="master-actor" id="master-actor">
                    <div class="master-actor-icon"><i class="bi bi-stars"></i></div>
                    <div class="master-actor-title">Master Actor</div>
                    <div class="master-actor-subtitle">LLM Choreographer</div>
                </div>
                
                <!-- Event Bus (Fixed Position) -->
                <div class="event-bus" id="event-bus">
                    <i class="bi bi-broadcast-pin"></i>
                    Swarm Event Bus
                </div>
                
                <!-- Dynamic nodes will be added here -->
            </div>
        </div>
    </div>
    
    <!-- RIGHT: Properties Panel -->
    <div class="properties-panel">
        <div class="properties-header">
            <i class="bi bi-sliders"></i>Properties
        </div>
        <div class="properties-body" id="properties-content">
            <div class="text-center py-5">
                <i class="bi bi-hand-index-thumb text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-3">
                    Drag components from the left<br>
                    onto the canvas to get started
                </p>
                <p class="small text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Connections are drawn automatically
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toast-container"></div>
{% endblock %}

{% block extra_js %}
<!-- jQuery UI for draggable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
<script>
// ============================================
// SWARM DESIGNER - COMPLETE REWRITE
// ============================================

const Designer = {
    swarmId: '{{ swarm.swarm_id if swarm else "" }}',
    triggers: [],
    agents: [],
    selected: null,
    counter: 0,
    
    colors: {
        trigger: {
            kafka: '#231f20',
            rabbitmq: '#ff6600',
            activemq: '#e42025',
            schedule: '#fd7e14',
            http: '#198754',
            user_query: '#0d6efd'
        },
        agents: ['#0d6efd', '#198754', '#dc3545', '#6f42c1', '#fd7e14', '#20c997', '#6610f2', '#d63384']
    }
};

// ============================================
// INITIALIZATION
// ============================================
$(document).ready(function() {
    console.log('ðŸš€ Swarm Designer initializing...');
    
    initPaletteDragDrop();
    loadExistingData();
    initCanvasEvents();
    
    // Initial render
    setTimeout(() => {
        drawAllConnections();
        centerCanvas();
    }, 100);
    
    console.log('âœ… Swarm Designer ready');
});

// ============================================
// PALETTE DRAG & DROP
// ============================================
function initPaletteDragDrop() {
    let dragData = null;
    let $ghost = null;
    
    $('.palette-item').on('mousedown', function(e) {
        if (e.button !== 0) return;
        e.preventDefault();
        
        const $item = $(this);
        
        // Store drag data
        dragData = {
            type: $item.data('type'),
            triggerType: $item.data('trigger-type'),
            agentId: $item.data('agent-id'),
            agentName: $item.data('agent-name')
        };
        
        // Create ghost element
        $ghost = $item.clone()
            .addClass('drag-ghost')
            .css({
                width: $item.outerWidth(),
                left: e.pageX - 50,
                top: e.pageY - 25
            })
            .appendTo('body');
        
        // Bind move/up handlers
        $(document).on('mousemove.drag', onDragMove);
        $(document).on('mouseup.drag', onDragEnd);
    });
    
    function onDragMove(e) {
        if (!$ghost) return;
        
        $ghost.css({
            left: e.pageX - 50,
            top: e.pageY - 25
        });
        
        // Highlight canvas when hovering
        const wrapper = document.getElementById('canvas-wrapper');
        const rect = wrapper.getBoundingClientRect();
        
        if (e.clientX >= rect.left && e.clientX <= rect.right &&
            e.clientY >= rect.top && e.clientY <= rect.bottom) {
            $('#canvas-wrapper').addClass('drag-over');
        } else {
            $('#canvas-wrapper').removeClass('drag-over');
        }
    }
    
    function onDragEnd(e) {
        $(document).off('.drag');
        $('#canvas-wrapper').removeClass('drag-over');
        
        if ($ghost) {
            $ghost.remove();
            $ghost = null;
        }
        
        if (!dragData) return;
        
        // Check if dropped on canvas
        const wrapper = document.getElementById('canvas-wrapper');
        const canvas = document.getElementById('design-canvas');
        const wrapperRect = wrapper.getBoundingClientRect();
        
        if (e.clientX >= wrapperRect.left && e.clientX <= wrapperRect.right &&
            e.clientY >= wrapperRect.top && e.clientY <= wrapperRect.bottom) {
            
            // Calculate position on canvas
            const x = e.clientX - wrapperRect.left + wrapper.scrollLeft;
            const y = e.clientY - wrapperRect.top + wrapper.scrollTop;
            
            // Create node
            if (dragData.type === 'trigger') {
                createTrigger(dragData.triggerType, x, Math.min(y, 100));
            } else if (dragData.type === 'agent') {
                createAgent(dragData.agentId, dragData.agentName, x, Math.max(y, 450));
            }
        }
        
        dragData = null;
    }
}

// ============================================
// CREATE TRIGGER NODE
// ============================================
function createTrigger(type, x, y) {
    Designer.counter++;
    const id = 'trigger-' + Designer.counter;
    
    const trigger = {
        id: id,
        type: type,
        name: type.charAt(0).toUpperCase() + type.slice(1).replace('_', ' ') + ' Trigger',
        config: getDefaultConfig(type),
        x: x - 80,
        y: y
    };
    
    Designer.triggers.push(trigger);
    renderTriggerNode(trigger);
    selectNode('trigger', id);
    drawAllConnections();
    
    showToast('success', 'Added ' + trigger.name);
}

function getDefaultConfig(type) {
    const configs = {
        kafka: { topic: 'swarm-events', group: 'swarm-consumer', bootstrap_servers: 'localhost:9092' },
        rabbitmq: { queue: 'swarm-queue', host: 'localhost', port: 5672 },
        schedule: { cron: '0 * * * *', timezone: 'UTC' },
        http: { endpoint: '/api/swarm/webhook', method: 'POST' },
        user_query: { prompt_template: '' }
    };
    return configs[type] || {};
}

function renderTriggerNode(trigger) {
    const color = Designer.colors.trigger[trigger.type] || '#ffc107';
    const icons = {
        kafka: 'bi-broadcast',
        rabbitmq: 'bi-envelope-fill',
        activemq: 'bi-broadcast',
        schedule: 'bi-clock-fill',
        http: 'bi-globe',
        user_query: 'bi-chat-dots-fill'
    };
    
    const html = `
        <div class="trigger-node" id="${trigger.id}" style="left: ${trigger.x}px; top: ${trigger.y}px;">
            <div class="trigger-node-header" style="background: ${color};">
                <i class="bi ${icons[trigger.type] || 'bi-lightning-fill'}"></i>
                <span>${trigger.name}</span>
            </div>
            <div class="trigger-node-body" style="border-top-color: ${color};">
                ${trigger.type.toUpperCase()}
            </div>
        </div>
    `;
    
    $('#design-canvas').append(html);
    makeNodeDraggable(trigger.id, 'trigger');
}

// ============================================
// CREATE AGENT NODE
// ============================================
function createAgent(agentId, agentName, x, y) {
    // Check if already added
    if (Designer.agents.find(a => a.agentId === agentId)) {
        showToast('warning', 'Agent already in swarm');
        return;
    }
    
    Designer.counter++;
    const id = 'agent-' + Designer.counter;
    
    const agent = {
        id: id,
        agentId: agentId,
        name: agentName,
        role: 'worker',
        subscriptions: ['task.*'],
        minInstances: 1,
        maxInstances: 5,
        autoScale: true,
        x: x - 90,
        y: y
    };
    
    Designer.agents.push(agent);
    renderAgentNode(agent);
    selectNode('agent', id);
    drawAllConnections();
    
    showToast('success', 'Added agent: ' + agentName);
}

function renderAgentNode(agent) {
    const colorIndex = Designer.agents.indexOf(agent) % Designer.colors.agents.length;
    const color = Designer.colors.agents[colorIndex];
    
    const subTags = agent.subscriptions.map(s => 
        `<span class="agent-subscription-tag"><i class="bi bi-lightning-charge-fill"></i>${s}</span>`
    ).join('');
    
    const html = `
        <div class="agent-node" id="${agent.id}" style="left: ${agent.x}px; top: ${agent.y}px;">
            <div class="agent-node-header" style="background: ${color};">
                <i class="bi bi-robot"></i>
                <div class="agent-info">
                    <div class="agent-name">${agent.name}</div>
                    <div class="agent-role">${agent.role}</div>
                </div>
            </div>
            <div class="agent-node-body">
                <div class="agent-subscriptions">${subTags || '<span class="text-muted small">No subscriptions</span>'}</div>
                <div class="agent-pool-info">
                    <i class="bi bi-layers-fill"></i>
                    Pool: ${agent.minInstances} - ${agent.maxInstances}
                    ${agent.autoScale ? '<i class="bi bi-arrow-repeat ms-1" title="Auto-scale"></i>' : ''}
                </div>
            </div>
        </div>
    `;
    
    $('#design-canvas').append(html);
    makeNodeDraggable(agent.id, 'agent');
}

// ============================================
// MAKE NODES DRAGGABLE
// ============================================
function makeNodeDraggable(nodeId, nodeType) {
    const $node = $('#' + nodeId);
    
    $node.draggable({
        containment: '#design-canvas',
        scroll: true,
        start: function() {
            $(this).addClass('ui-draggable-dragging');
        },
        drag: function() {
            drawAllConnections();
        },
        stop: function(e, ui) {
            $(this).removeClass('ui-draggable-dragging');
            
            // Update position in state
            const item = nodeType === 'trigger' 
                ? Designer.triggers.find(t => t.id === nodeId)
                : Designer.agents.find(a => a.id === nodeId);
            
            if (item) {
                item.x = ui.position.left;
                item.y = ui.position.top;
            }
            
            drawAllConnections();
        }
    });
    
    $node.on('click', function(e) {
        e.stopPropagation();
        selectNode(nodeType, nodeId);
    });
}

// ============================================
// DRAW ALL CONNECTIONS
// ============================================
function drawAllConnections() {
    const svg = document.getElementById('connections-svg');
    if (!svg) return;
    
    // Clear existing paths (keep defs)
    const paths = svg.querySelectorAll('path.connection-path');
    paths.forEach(p => p.remove());
    
    const master = document.getElementById('master-actor');
    const eventBus = document.getElementById('event-bus');
    
    if (!master || !eventBus) return;
    
    // Get master and bus positions
    const masterX = master.offsetLeft + master.offsetWidth / 2;
    const masterTop = master.offsetTop;
    const masterBottom = master.offsetTop + master.offsetHeight;
    
    const busX = eventBus.offsetLeft + eventBus.offsetWidth / 2;
    const busTop = eventBus.offsetTop;
    const busBottom = eventBus.offsetTop + eventBus.offsetHeight;
    
    // Draw: Master -> Event Bus
    drawConnection(svg, masterX, masterBottom, busX, busTop, 'master-to-bus', 'arrow-purple');
    
    // Draw: Triggers -> Master
    Designer.triggers.forEach(trigger => {
        const el = document.getElementById(trigger.id);
        if (el) {
            const x = el.offsetLeft + el.offsetWidth / 2;
            const y = el.offsetTop + el.offsetHeight;
            drawConnection(svg, x, y, masterX, masterTop, 'trigger-to-master', 'arrow-yellow');
        }
    });
    
    // Draw: Event Bus -> Agents
    Designer.agents.forEach(agent => {
        const el = document.getElementById(agent.id);
        if (el) {
            const x = el.offsetLeft + el.offsetWidth / 2;
            const y = el.offsetTop;
            drawConnection(svg, busX, busBottom, x, y, 'bus-to-agent', 'arrow-cyan');
        }
    });
}

function drawConnection(svg, x1, y1, x2, y2, className, markerId) {
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    
    // Calculate control points for smooth curve
    const midY = (y1 + y2) / 2;
    const d = `M ${x1} ${y1} C ${x1} ${midY}, ${x2} ${midY}, ${x2} ${y2}`;
    
    path.setAttribute('d', d);
    path.setAttribute('class', 'connection-path ' + className);
    path.setAttribute('marker-end', 'url(#' + markerId + ')');
    
    svg.appendChild(path);
}

// ============================================
// SELECTION & PROPERTIES
// ============================================
function selectNode(type, id) {
    // Deselect previous
    $('.trigger-node, .agent-node').removeClass('selected');
    
    // Select new
    $('#' + id).addClass('selected');
    Designer.selected = { type, id };
    
    // Show properties
    if (type === 'trigger') {
        const trigger = Designer.triggers.find(t => t.id === id);
        showTriggerProperties(trigger);
    } else if (type === 'agent') {
        const agent = Designer.agents.find(a => a.id === id);
        showAgentProperties(agent);
    }
}

function showTriggerProperties(trigger) {
    let configFields = '';
    
    if (trigger.type === 'kafka') {
        configFields = `
            <div class="prop-group">
                <div class="prop-label">Kafka Topic</div>
                <input type="text" class="prop-input" value="${trigger.config.topic || ''}" 
                       onchange="updateTriggerConfig('${trigger.id}', 'topic', this.value)">
            </div>
            <div class="prop-group">
                <div class="prop-label">Consumer Group</div>
                <input type="text" class="prop-input" value="${trigger.config.group || ''}" 
                       onchange="updateTriggerConfig('${trigger.id}', 'group', this.value)">
            </div>
        `;
    } else if (trigger.type === 'schedule') {
        configFields = `
            <div class="prop-group">
                <div class="prop-label">Cron Expression</div>
                <input type="text" class="prop-input" value="${trigger.config.cron || '0 * * * *'}" 
                       onchange="updateTriggerConfig('${trigger.id}', 'cron', this.value)">
                <div class="prop-hint">Format: minute hour day month weekday</div>
            </div>
        `;
    } else if (trigger.type === 'http') {
        configFields = `
            <div class="prop-group">
                <div class="prop-label">Webhook Endpoint</div>
                <input type="text" class="prop-input" value="${trigger.config.endpoint || ''}" 
                       onchange="updateTriggerConfig('${trigger.id}', 'endpoint', this.value)">
            </div>
        `;
    } else if (trigger.type === 'rabbitmq') {
        configFields = `
            <div class="prop-group">
                <div class="prop-label">Queue Name</div>
                <input type="text" class="prop-input" value="${trigger.config.queue || ''}" 
                       onchange="updateTriggerConfig('${trigger.id}', 'queue', this.value)">
            </div>
        `;
    }
    
    const html = `
        <h6 class="mb-3"><i class="bi bi-lightning-fill me-2 text-warning"></i>Trigger Properties</h6>
        
        <div class="prop-group">
            <div class="prop-label">Trigger Name</div>
            <input type="text" class="prop-input" value="${trigger.name}" 
                   onchange="updateTrigger('${trigger.id}', 'name', this.value)">
        </div>
        
        <div class="prop-group">
            <div class="prop-label">Trigger Type</div>
            <input type="text" class="prop-input" value="${trigger.type.toUpperCase()}" disabled>
        </div>
        
        ${configFields}
        
        <hr class="my-3">
        
        <button class="btn btn-outline-danger btn-sm w-100" onclick="removeTrigger('${trigger.id}')">
            <i class="bi bi-trash me-1"></i>Remove Trigger
        </button>
    `;
    
    $('#properties-content').html(html);
}

function showAgentProperties(agent) {
    const html = `
        <h6 class="mb-3"><i class="bi bi-robot me-2 text-primary"></i>Agent Properties</h6>
        
        <div class="prop-group">
            <div class="prop-label">Agent Name</div>
            <input type="text" class="prop-input" value="${agent.name}" disabled>
        </div>
        
        <div class="prop-group">
            <div class="prop-label">Role</div>
            <select class="prop-input" onchange="updateAgent('${agent.id}', 'role', this.value)">
                <option value="worker" ${agent.role === 'worker' ? 'selected' : ''}>Worker</option>
                <option value="specialist" ${agent.role === 'specialist' ? 'selected' : ''}>Specialist</option>
                <option value="coordinator" ${agent.role === 'coordinator' ? 'selected' : ''}>Coordinator</option>
            </select>
        </div>
        
        <div class="prop-group">
            <div class="prop-label">Event Subscriptions</div>
            <input type="text" class="prop-input" value="${agent.subscriptions.join(', ')}" 
                   onchange="updateAgentSubscriptions('${agent.id}', this.value)">
            <div class="prop-hint">Comma-separated patterns: task.*, result.search</div>
        </div>
        
        <div class="prop-group">
            <div class="prop-label">Instance Pool Size</div>
            <div class="d-flex gap-2 align-items-center">
                <input type="number" class="prop-input" style="width: 70px;" value="${agent.minInstances}" 
                       min="0" max="50" onchange="updateAgent('${agent.id}', 'minInstances', parseInt(this.value))">
                <span class="text-muted">to</span>
                <input type="number" class="prop-input" style="width: 70px;" value="${agent.maxInstances}" 
                       min="1" max="100" onchange="updateAgent('${agent.id}', 'maxInstances', parseInt(this.value))">
            </div>
        </div>
        
        <div class="prop-group">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="autoScale" 
                       ${agent.autoScale ? 'checked' : ''} 
                       onchange="updateAgent('${agent.id}', 'autoScale', this.checked)">
                <label class="form-check-label" for="autoScale">Enable auto-scaling</label>
            </div>
        </div>
        
        <hr class="my-3">
        
        <button class="btn btn-outline-danger btn-sm w-100" onclick="removeAgent('${agent.id}')">
            <i class="bi bi-trash me-1"></i>Remove Agent
        </button>
    `;
    
    $('#properties-content').html(html);
}

// ============================================
// UPDATE FUNCTIONS
// ============================================
function updateTrigger(id, prop, value) {
    const trigger = Designer.triggers.find(t => t.id === id);
    if (trigger) {
        trigger[prop] = value;
        refreshNode(id, 'trigger', trigger);
    }
}

function updateTriggerConfig(id, key, value) {
    const trigger = Designer.triggers.find(t => t.id === id);
    if (trigger) {
        trigger.config[key] = value;
    }
}

function updateAgent(id, prop, value) {
    const agent = Designer.agents.find(a => a.id === id);
    if (agent) {
        agent[prop] = value;
        refreshNode(id, 'agent', agent);
    }
}

function updateAgentSubscriptions(id, value) {
    const agent = Designer.agents.find(a => a.id === id);
    if (agent) {
        agent.subscriptions = value.split(',').map(s => s.trim()).filter(s => s);
        refreshNode(id, 'agent', agent);
    }
}

function refreshNode(id, type, data) {
    const $node = $('#' + id);
    const x = $node.position().left;
    const y = $node.position().top;
    
    data.x = x;
    data.y = y;
    
    $node.remove();
    
    if (type === 'trigger') {
        renderTriggerNode(data);
    } else {
        renderAgentNode(data);
    }
    
    drawAllConnections();
}

// ============================================
// REMOVE FUNCTIONS
// ============================================
function removeTrigger(id) {
    Designer.triggers = Designer.triggers.filter(t => t.id !== id);
    $('#' + id).remove();
    drawAllConnections();
    clearProperties();
    showToast('info', 'Trigger removed');
}

function removeAgent(id) {
    Designer.agents = Designer.agents.filter(a => a.id !== id);
    $('#' + id).remove();
    drawAllConnections();
    clearProperties();
    showToast('info', 'Agent removed');
}

function clearProperties() {
    Designer.selected = null;
    $('#properties-content').html(`
        <div class="text-center py-5">
            <i class="bi bi-hand-index-thumb text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3">Select a node to edit properties</p>
        </div>
    `);
}

// ============================================
// CANVAS EVENTS
// ============================================
function initCanvasEvents() {
    $('#design-canvas').on('click', function(e) {
        if (e.target === this) {
            $('.trigger-node, .agent-node').removeClass('selected');
            clearProperties();
        }
    });
    
    // Keyboard shortcuts
    $(document).on('keydown', function(e) {
        if (e.key === 'Delete' && Designer.selected) {
            if (Designer.selected.type === 'trigger') {
                removeTrigger(Designer.selected.id);
            } else if (Designer.selected.type === 'agent') {
                removeAgent(Designer.selected.id);
            }
        }
    });
}

function centerCanvas() {
    const wrapper = document.getElementById('canvas-wrapper');
    const master = document.getElementById('master-actor');
    
    if (wrapper && master) {
        const scrollX = master.offsetLeft - wrapper.clientWidth / 2 + master.offsetWidth / 2;
        wrapper.scrollTo({ left: Math.max(0, scrollX), top: 0, behavior: 'smooth' });
    }
}

// ============================================
// LOAD EXISTING DATA
// ============================================
function loadExistingData() {
    {% for membership in memberships %}
    Designer.agents.push({
        id: 'agent-existing-{{ loop.index }}',
        agentId: '{{ membership.agent_id }}',
        name: '{{ membership.agent_name }}',
        role: '{{ membership.role }}',
        subscriptions: {{ membership.subscriptions | map(attribute='event_pattern') | list | tojson | safe if membership.subscriptions else '["task.*"]' }},
        minInstances: {{ membership.min_instances }},
        maxInstances: {{ membership.max_instances }},
        autoScale: {{ 'true' if membership.auto_scale else 'false' }},
        x: {{ 200 + loop.index0 * 220 }},
        y: 480
    });
    {% endfor %}
    
    {% for trigger in triggers %}
    Designer.triggers.push({
        id: 'trigger-existing-{{ loop.index }}',
        type: '{{ trigger.trigger_type }}',
        name: '{{ trigger.name or trigger.trigger_type }}',
        config: {{ trigger.config | tojson | safe if trigger.config else '{}' }},
        x: {{ 200 + loop.index0 * 200 }},
        y: 30
    });
    {% endfor %}
    
    // Render existing nodes
    Designer.agents.forEach(a => renderAgentNode(a));
    Designer.triggers.forEach(t => renderTriggerNode(t));
}

// ============================================
// SAVE SWARM
// ============================================
function saveSwarm() {
    const data = {
        name: $('#swarm-name').val(),
        agents: Designer.agents.map(a => ({
            agent_id: a.agentId,
            agent_name: a.name,
            role: a.role,
            subscriptions: a.subscriptions.map(s => ({ event_pattern: s })),
            min_instances: a.minInstances,
            max_instances: a.maxInstances,
            auto_scale: a.autoScale
        })),
        triggers: Designer.triggers.map(t => ({
            trigger_type: t.type,
            name: t.name,
            config: t.config
        }))
    };
    
    $.ajax({
        url: '/api/swarms/' + Designer.swarmId + '/save',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                showToast('success', 'Swarm saved successfully!');
            } else {
                showToast('error', 'Save failed: ' + (response.error || 'Unknown error'));
            }
        },
        error: function(xhr) {
            showToast('error', 'Failed to save swarm');
        }
    });
}

// ============================================
// TOAST NOTIFICATIONS
// ============================================
function showToast(type, message) {
    const bgClass = {
        success: 'bg-success',
        error: 'bg-danger',
        warning: 'bg-warning text-dark',
        info: 'bg-info text-dark'
    }[type] || 'bg-secondary';
    
    const toast = $(`
        <div class="toast align-items-center ${bgClass} text-white border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `);
    
    $('#toast-container').append(toast);
    const bsToast = new bootstrap.Toast(toast[0], { delay: 3000 });
    bsToast.show();
    
    toast.on('hidden.bs.toast', () => toast.remove());
}
</script>
{% endblock %}
