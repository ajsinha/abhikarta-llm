{% extends "help/help_base.html" %}

{% set title = "MCP Plugins & Server Management" %}
{% set description = "Connect external tools using Model Context Protocol" %}
{% set icon = "bi-plug" %}
{% set header_color = "#6c757d" %}
{% set header_color_dark = "#495057" %}

{% block help_nav %}
<a href="#overview">Overview</a>
<a href="#server-manager">MCPServerManager</a>
<a href="#plugin-types">Plugin Types</a>
<a href="#http-plugins">HTTP Plugins</a>
<a href="#creating-server">Creating MCP Server</a>
<a href="#tool-integration">Tool Integration</a>
<a href="#health-monitoring">Health Monitoring</a>
{% endblock %}

{% block help_content %}
<h2 id="overview">Overview</h2>
<p>The Model Context Protocol (MCP) allows you to extend agent capabilities by connecting to external tools and services. Version 1.1.6 introduces centralized MCP server management.</p>

<div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    <strong>New in v1.1.6:</strong> Centralized <code>MCPServerManager</code> for server lifecycle, health monitoring, and automatic tool registration with the <code>ToolsRegistry</code>.
</div>

<hr class="my-5">

<h2 id="server-manager">MCPServerManager</h2>
<p>Centralized singleton for managing all MCP server connections.</p>

<pre><code class="language-python">from abhikarta.mcp import get_mcp_manager, MCPServerConfig

# Get the manager instance
manager = get_mcp_manager()

# Add a server
config = MCPServerConfig(
    server_id="weather-server",
    name="Weather API",
    url="http://localhost:8080",
    auto_connect=True
)
manager.add_server(config)

# Connect to server
manager.connect_server("weather-server")

# List connected servers
servers = manager.list_servers(connected_only=True)

# Get server tools
tools = manager.get_server_tools("weather-server")

# Health check
healthy, latency = manager.check_health("weather-server")

# Start background health monitoring
manager.start_health_monitor(interval_seconds=30)</code></pre>

<div class="row g-4 mb-4 mt-4">
    <div class="col-md-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="bi bi-plug text-success" style="font-size: 2rem;"></i>
                <h5 class="mt-2">Auto-Connect</h5>
                <p class="small text-muted">Servers connect automatically on startup</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="bi bi-heart-pulse text-danger" style="font-size: 2rem;"></i>
                <h5 class="mt-2">Health Monitoring</h5>
                <p class="small text-muted">Background health checks with auto-reconnect</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="bi bi-tools text-primary" style="font-size: 2rem;"></i>
                <h5 class="mt-2">Tool Registration</h5>
                <p class="small text-muted">Tools auto-register with ToolsRegistry</p>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<h2 id="plugin-types">Plugin Types</h2>
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h5><i class="bi bi-globe text-primary me-2"></i>HTTP/SSE Plugins</h5>
                <p>Connect to web-based MCP servers via HTTP with Server-Sent Events for streaming.</p>
                <ul>
                    <li>REST API endpoints</li>
                    <li>Real-time tool discovery</li>
                    <li>Streaming responses</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-body">
                <h5><i class="bi bi-hdd-network text-info me-2"></i>WebSocket Plugins</h5>
                <p>Real-time bidirectional communication with MCP servers.</p>
                <ul>
                    <li>Persistent connections</li>
                    <li>Lower latency</li>
                    <li>Event-driven</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<h2 id="http-plugins">Registering HTTP Plugin</h2>
<ol>
    <li>Navigate to <strong>Admin → MCP Tool Servers</strong></li>
    <li>Click <strong>"Add Server"</strong></li>
    <li>Configure:</li>
</ol>

<pre><code class="language-json">{
  "server_id": "weather-api",
  "name": "Weather API",
  "url": "http://localhost:8080",
  "transport": "http",
  "auth_type": "bearer_token",
  "auth_token": "your-api-key",
  "auto_connect": true,
  "timeout_seconds": 30
}</code></pre>

<hr class="my-5">

<h2 id="creating-server">Creating an MCP Server</h2>
<h5>Python with FastMCP</h5>
<pre><code class="language-python">from fastmcp import FastMCP

mcp = FastMCP("Weather Service")

@mcp.tool()
def get_weather(city: str) -> str:
    """Get current weather for a city"""
    return f"Weather in {city}: 72°F, Sunny"

@mcp.tool()
def get_forecast(city: str, days: int = 5) -> str:
    """Get weather forecast"""
    return f"{days}-day forecast for {city}..."

# Run with: uvicorn mcp_server:mcp.app --port 8080</code></pre>

<hr class="my-5">

<h2 id="tool-integration">Automatic Tool Integration</h2>
<p>When an MCP server connects, its tools are automatically wrapped as <code>MCPTool</code> instances and registered with the <code>ToolsRegistry</code>.</p>

<pre><code class="language-python">from abhikarta.tools import get_tools_registry
from abhikarta.mcp import get_mcp_manager

# Connect to MCP server
manager = get_mcp_manager()
manager.connect_server("weather-server")

# Tools are now in the registry
registry = get_tools_registry()
weather_tool = registry.get("weather-server_get_weather")

# Execute the tool
result = registry.execute("weather-server_get_weather", city="London")

# Or use with agents - convert to LLM format
openai_tools = registry.to_openai_functions()
anthropic_tools = registry.to_anthropic_tools()
langchain_tools = registry.to_langchain_tools()</code></pre>

<hr class="my-5">

<h2 id="health-monitoring">Health Monitoring</h2>
<pre><code class="language-python"># Start background monitoring
manager.start_health_monitor(interval_seconds=30)

# Get statistics
stats = manager.get_stats()
# {
#   "total_servers": 3,
#   "connected_servers": 2,
#   "disconnected_servers": 1,
#   "total_tools": 15,
#   "servers": {...}
# }

# Stop monitoring
manager.stop_health_monitor()</code></pre>

<div class="alert alert-success mt-4">
    <h5><i class="bi bi-check-circle me-2"></i>Best Practices</h5>
    <ul class="mb-0">
        <li>Enable <code>auto_connect</code> for production servers</li>
        <li>Use health monitoring for critical integrations</li>
        <li>Set appropriate timeouts for your use case</li>
        <li>Use authentication for production MCP servers</li>
        <li>Tools from MCP servers extend <code>BaseTool</code> and work with all components</li>
    </ul>
</div>
{% endblock %}
