{% extends "base.html" %}

{% block title %}{{ title }} - Documentation - {{ app_name }}{% endblock %}

{% block extra_css %}
<!-- Highlight.js Theme for Code Syntax -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<style>
    .doc-hero {
        background: linear-gradient(135deg, #6f42c1 0%, #d63384 100%);
        color: white;
        padding: 2rem 0;
    }
    
    .doc-container {
        display: flex;
        gap: 2rem;
        padding: 2rem 0;
    }
    
    /* Table of Contents Sidebar */
    .doc-toc {
        width: 280px;
        flex-shrink: 0;
        position: sticky;
        top: 20px;
        align-self: flex-start;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
    }
    
    .doc-toc-card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 1.25rem;
    }
    
    .doc-toc-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: #333;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #6f42c1;
    }
    
    .doc-toc-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .doc-toc-list li {
        margin-bottom: 0.5rem;
    }
    
    .doc-toc-list a {
        color: #555;
        text-decoration: none;
        font-size: 0.85rem;
        display: block;
        padding: 0.25rem 0;
        transition: color 0.2s;
    }
    
    .doc-toc-list a:hover {
        color: #6f42c1;
    }
    
    .doc-toc-list a.active {
        color: #6f42c1;
        font-weight: 600;
    }
    
    .doc-toc-list .toc-h2 {
        padding-left: 0;
    }
    
    .doc-toc-list .toc-h3 {
        padding-left: 1rem;
        font-size: 0.8rem;
    }
    
    .doc-toc-list .toc-h4 {
        padding-left: 2rem;
        font-size: 0.75rem;
        color: #888;
    }
    
    /* Main Content */
    .doc-content {
        flex: 1;
        min-width: 0;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        padding: 2.5rem;
    }
    
    /* Markdown Rendered Styles */
    .markdown-body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        font-size: 16px;
        line-height: 1.7;
        color: #24292e;
    }
    
    .markdown-body h1 {
        font-size: 2rem;
        font-weight: 700;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #6f42c1;
        margin-bottom: 1.5rem;
        color: #6f42c1;
    }
    
    .markdown-body h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-top: 2.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.3rem;
        border-bottom: 1px solid #eee;
        color: #333;
    }
    
    .markdown-body h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-top: 2rem;
        margin-bottom: 0.75rem;
        color: #444;
    }
    
    .markdown-body h4 {
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
        color: #555;
    }
    
    .markdown-body p {
        margin-bottom: 1rem;
    }
    
    .markdown-body a {
        color: #6f42c1;
        text-decoration: none;
    }
    
    .markdown-body a:hover {
        text-decoration: underline;
    }
    
    .markdown-body code {
        background: #f6f8fa;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.9em;
        color: #d63384;
    }
    
    .markdown-body pre {
        background: #0d1117;
        border-radius: 8px;
        padding: 1rem;
        overflow-x: auto;
        margin: 1rem 0;
    }
    
    .markdown-body pre code {
        background: transparent;
        padding: 0;
        color: #c9d1d9;
        font-size: 0.875rem;
    }
    
    .markdown-body table {
        width: 100%;
        border-collapse: collapse;
        margin: 1rem 0;
    }
    
    .markdown-body table th,
    .markdown-body table td {
        padding: 0.75rem 1rem;
        border: 1px solid #e1e4e8;
        text-align: left;
    }
    
    .markdown-body table th {
        background: #f6f8fa;
        font-weight: 600;
    }
    
    .markdown-body table tr:nth-child(even) {
        background: #fafbfc;
    }
    
    .markdown-body blockquote {
        border-left: 4px solid #6f42c1;
        padding-left: 1rem;
        color: #666;
        margin: 1rem 0;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0 8px 8px 0;
    }
    
    .markdown-body ul, .markdown-body ol {
        padding-left: 2rem;
        margin-bottom: 1rem;
    }
    
    .markdown-body li {
        margin-bottom: 0.5rem;
    }
    
    .markdown-body hr {
        border: none;
        border-top: 2px solid #eee;
        margin: 2rem 0;
    }
    
    .markdown-body img {
        max-width: 100%;
        border-radius: 8px;
    }
    
    /* Loading State */
    .loading-state {
        text-align: center;
        padding: 3rem;
    }
    
    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #6f42c1;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Error State */
    .error-state {
        text-align: center;
        padding: 3rem;
        color: #dc3545;
    }
    
    /* Print Styles */
    @media print {
        .doc-toc, .doc-hero, .breadcrumb {
            display: none !important;
        }
        .doc-content {
            box-shadow: none;
            padding: 0;
        }
    }
    
    /* Mobile Responsive */
    @media (max-width: 991px) {
        .doc-container {
            flex-direction: column;
        }
        .doc-toc {
            width: 100%;
            position: static;
            max-height: none;
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="doc-hero">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('help') }}" class="text-white-50">Help</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('markdown_docs') }}" class="text-white-50">Documentation</a></li>
                <li class="breadcrumb-item active text-white">{{ title }}</li>
            </ol>
        </nav>
        <h1 class="display-6 fw-bold mb-2">
            <i class="bi bi-markdown me-2"></i>{{ title }}
        </h1>
        <p class="mb-0 opacity-75">
            <i class="bi bi-file-earmark-text me-1"></i>{{ filename }}.md
            <span class="ms-3"><i class="bi bi-broadcast-pin me-1"></i>Live rendered from Markdown</span>
        </p>
    </div>
</div>

<div class="container">
    <div class="doc-container">
        <!-- Table of Contents Sidebar -->
        <div class="doc-toc">
            <div class="doc-toc-card">
                <div class="doc-toc-title">
                    <i class="bi bi-list-ul me-2"></i>Contents
                </div>
                <ul class="doc-toc-list" id="toc-list">
                    <li><em class="text-muted small">Loading...</em></li>
                </ul>
            </div>
            
            <!-- Quick Actions -->
            <div class="doc-toc-card mt-3">
                <div class="doc-toc-title">
                    <i class="bi bi-lightning me-2"></i>Actions
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="window.print()">
                        <i class="bi bi-printer me-1"></i>Print
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard()">
                        <i class="bi bi-clipboard me-1"></i>Copy Link
                    </button>
                    <a href="{{ url_for('markdown_docs') }}" class="btn btn-outline-dark btn-sm">
                        <i class="bi bi-arrow-left me-1"></i>All Docs
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="doc-content">
            <div id="loading-state" class="loading-state">
                <div class="loading-spinner"></div>
                <p class="text-muted">Loading documentation...</p>
            </div>
            <div id="error-state" class="error-state" style="display: none;">
                <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                <h4 class="mt-3">Failed to Load Document</h4>
                <p id="error-message">Unable to load the requested markdown file.</p>
                <a href="{{ url_for('markdown_docs') }}" class="btn btn-primary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Documentation
                </a>
            </div>
            <div id="markdown-content" class="markdown-body" style="display: none;"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Marked.js for Markdown Rendering -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
<!-- Highlight.js for Syntax Highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
// ============================================
// MARKDOWN VIEWER - LIVE RENDERING
// ============================================

const filename = '{{ filename }}';

// Configure marked.js
marked.setOptions({
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            try {
                return hljs.highlight(code, { language: lang }).value;
            } catch (e) {}
        }
        return hljs.highlightAuto(code).value;
    },
    breaks: true,
    gfm: true
});

// Load and render markdown
async function loadMarkdown() {
    try {
        const response = await fetch(`/api/markdown/${filename}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Unknown error');
        }
        
        // Render markdown to HTML
        const html = marked.parse(data.content);
        
        // Show content
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('markdown-content').innerHTML = html;
        document.getElementById('markdown-content').style.display = 'block';
        
        // Generate Table of Contents
        generateTOC();
        
        // Apply syntax highlighting to any missed code blocks
        document.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightElement(block);
        });
        
        // Add IDs to headings for anchor links
        addHeadingIds();
        
    } catch (error) {
        console.error('Error loading markdown:', error);
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('error-state').style.display = 'block';
        document.getElementById('error-message').textContent = error.message;
    }
}

// Generate Table of Contents from headings
function generateTOC() {
    const content = document.getElementById('markdown-content');
    const headings = content.querySelectorAll('h1, h2, h3, h4');
    const tocList = document.getElementById('toc-list');
    
    tocList.innerHTML = '';
    
    let tocHtml = '';
    headings.forEach((heading, index) => {
        // Generate slug-based ID from heading text (like GitHub does)
        const slug = heading.textContent
            .toLowerCase()
            .replace(/[^a-z0-9\s-]/g, '')  // Remove special chars except spaces and hyphens
            .replace(/\s+/g, '-')          // Replace spaces with hyphens
            .replace(/-+/g, '-')           // Collapse multiple hyphens
            .replace(/^-|-$/g, '');        // Remove leading/trailing hyphens
        
        const id = slug || `heading-${index}`;
        heading.id = id;
        
        const level = heading.tagName.toLowerCase();
        const text = heading.textContent;
        
        tocHtml += `
            <li>
                <a href="#${id}" class="toc-${level}" onclick="scrollToHeading('${id}')">${text}</a>
            </li>
        `;
    });
    
    tocList.innerHTML = tocHtml || '<li><em class="text-muted small">No headings found</em></li>';
}

// Add IDs to headings (backup for any missed)
function addHeadingIds() {
    const content = document.getElementById('markdown-content');
    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    
    headings.forEach((heading, index) => {
        if (!heading.id) {
            const slug = heading.textContent
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
            heading.id = slug || `heading-${index}`;
        }
    });
}

// Smooth scroll to heading
function scrollToHeading(id) {
    const element = document.getElementById(id);
    if (element) {
        element.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Update active TOC item
        document.querySelectorAll('.doc-toc-list a').forEach(a => a.classList.remove('active'));
        document.querySelector(`.doc-toc-list a[href="#${id}"]`)?.classList.add('active');
    }
    return false;
}

// Copy link to clipboard
function copyToClipboard() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        alert('Link copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

// Highlight active TOC item on scroll
function highlightActiveTOC() {
    const headings = document.querySelectorAll('.markdown-body h1, .markdown-body h2, .markdown-body h3');
    const tocLinks = document.querySelectorAll('.doc-toc-list a');
    
    let currentActive = null;
    
    headings.forEach(heading => {
        const rect = heading.getBoundingClientRect();
        if (rect.top <= 100) {
            currentActive = heading.id;
        }
    });
    
    tocLinks.forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('href') === `#${currentActive}`) {
            link.classList.add('active');
        }
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadMarkdown();
    window.addEventListener('scroll', highlightActiveTOC);
});
</script>
{% endblock %}
