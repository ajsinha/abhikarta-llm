{% extends "help/help_base.html" %}

{% set title = "System Architecture" %}
{% set description = "Technical design and component overview" %}
{% set icon = "bi-building" %}
{% set header_color = "#198754" %}
{% set header_color_dark = "#146c43" %}

{% block help_nav %}
<a href="#overview">Overview</a>
<a href="#layers">Architecture Layers</a>
<a href="#ai-org">AI Organizations</a>
<a href="#notifications">Notifications</a>
<a href="#swarms">Agent Swarms</a>
<a href="#database">Database Schema</a>
<a href="#workflow-engine">Workflow Engine</a>
<a href="#code-loader">Code Loader</a>
<a href="#llm-facade">LLM Facade</a>
{% endblock %}

{% block help_content %}
<h2 id="overview">Architecture Overview</h2>
<p class="lead">Abhikarta-LLM follows a layered architecture with clear separation of concerns.</p>

<pre><code class="language-text">┌─────────────────────────────────────────────────────────────────────┐
│                      PRESENTATION LAYER                              │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐                 │
│  │   Web UI     │ │  REST API    │ │   CLI        │                 │
│  │   (Flask)    │ │  Endpoints   │ │   Tools      │                 │
│  └──────────────┘ └──────────────┘ └──────────────┘                 │
├─────────────────────────────────────────────────────────────────────┤
│                        API LAYER                                     │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │
│  │  Auth      │ │  Agent     │ │  Workflow  │ │  AI Org    │       │
│  │  Routes    │ │  Routes    │ │  Routes    │ │  Routes    │       │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │
├─────────────────────────────────────────────────────────────────────┤
│                     CORE SERVICES                                    │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │
│  │   Agent    │ │  Workflow  │ │    LLM     │ │   HITL     │       │
│  │  Manager   │ │  Executor  │ │   Facade   │ │  Manager   │       │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │
│  │   User     │ │   RBAC     │ │   Code     │ │   Audit    │       │
│  │  Manager   │ │  Manager   │ │  Loader    │ │   Logger   │       │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │
├─────────────────────────────────────────────────────────────────────┤
│                  AI ORGANIZATIONS (v1.4.5)                           │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │                    AI Org Manager                         │       │
│  │   (Hierarchical Orgs, Task Delegation, Aggregation)      │       │
│  └──────────────────────────────────────────────────────────┘       │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │
│  │  AI Node   │ │   Task     │ │  Response  │ │  Human     │       │
│  │  Manager   │ │  Manager   │ │ Aggregator │ │  Mirror    │       │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │
├─────────────────────────────────────────────────────────────────────┤
│                  NOTIFICATIONS (v1.4.0)                              │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │              NotificationManager                          │       │
│  │   (Multi-channel routing, Rate Limiting, Retry Logic)    │       │
│  └──────────────────────────────────────────────────────────┘       │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │
│  │   Slack    │ │   Teams    │ │   Email    │ │  Webhook   │       │
│  │  Adapter   │ │  Adapter   │ │  Adapter   │ │  Receiver  │       │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │
├─────────────────────────────────────────────────────────────────────┤
│                    SWARMS (v1.3.0)                                   │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │                    SwarmManager                           │       │
│  │   (Master Actor, Agent Pools, Event-Driven Choreo)       │       │
│  └──────────────────────────────────────────────────────────┘       │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │
│  │  Master    │ │   Event    │ │   Agent    │ │  External  │       │
│  │  Actor     │ │    Bus     │ │   Pools    │ │  Triggers  │       │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │
├─────────────────────────────────────────────────────────────────────┤
│                     TOOLS LAYER                                      │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │                    ToolsRegistry                          │       │
│  │   (Centralized Tool Management & Discovery)              │       │
│  └──────────────────────────────────────────────────────────┘       │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐       │
│  │ Function   │ │   MCP      │ │   HTTP     │ │   Code     │       │
│  │   Tool     │ │   Tool     │ │   Tool     │ │  Fragment  │       │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘       │
│                         ▲ BaseTool (Abstract)                        │
├─────────────────────────────────────────────────────────────────────┤
│                      MCP LAYER                                       │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │                  MCPServerManager                         │       │
│  │   (Server Lifecycle, Health Monitoring, Auto-Connect)    │       │
│  └──────────────────────────────────────────────────────────┘       │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐                       │
│  │   HTTP     │ │ WebSocket  │ │   SSE      │                       │
│  │  Client    │ │  Client    │ │  Client    │                       │
│  └────────────┘ └────────────┘ └────────────┘                       │
├─────────────────────────────────────────────────────────────────────┤
│                  EXTERNAL CODE SOURCES                               │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐                       │
│  │   db://    │ │  file://   │ │   s3://    │                       │
│  │ (Database) │ │(Filesystem)│ │  (AWS S3)  │                       │
│  └────────────┘ └────────────┘ └────────────┘                       │
├─────────────────────────────────────────────────────────────────────┤
│                      DATABASE LAYER                                  │
│  ┌──────────────────────────────────────────────────────────┐       │
│  │                    DB Facade                              │       │
│  │         (SQLite / PostgreSQL Abstraction)                │       │
│  └──────────────────────────────────────────────────────────┘       │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │  33+ Tables: Users, Agents, Workflows, Swarms, AI Orgs,       │ │
│  │  Notifications, Executions, HITL Tasks, Audit Logs, etc.      │ │
│  └────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘</code></pre>

<hr class="my-5">

<h2 id="layers">Architecture Layers</h2>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Presentation Layer</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>Web UI:</strong> Flask templates with Bootstrap 5</li>
                    <li><strong>REST API:</strong> JSON endpoints for programmatic access</li>
                    <li><strong>CLI:</strong> Command-line tools for admin tasks</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Core Services</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>Agent Manager:</strong> Agent CRUD and lifecycle</li>
                    <li><strong>Workflow Executor:</strong> DAG parsing and execution</li>
                    <li><strong>LLM Facade:</strong> Unified LLM interface with logging</li>
                    <li><strong>HITL Manager:</strong> Human-in-the-loop task management</li>
                    <li><strong>Code Loader:</strong> URI-based code resolution</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Tools Layer (v1.1.6+)</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>ToolsRegistry:</strong> Centralized tool management singleton</li>
                    <li><strong>BaseTool:</strong> Abstract base class for all tools</li>
                    <li><strong>FunctionTool:</strong> Python function wrappers</li>
                    <li><strong>MCPTool:</strong> MCP server tool wrappers</li>
                    <li><strong>HTTPTool:</strong> REST API tool wrappers</li>
                    <li><strong>CodeFragmentTool:</strong> Database code fragments</li>
                    <li><strong>LangChainTool:</strong> LangChain integration</li>
                    <li><strong>Pre-built Tools (v1.3.0):</strong> 85+ ready-to-use tools</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Template Libraries (v1.3.0)</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>Agent Templates:</strong> 36 templates across 15 categories</li>
                    <li><strong>Workflow Templates:</strong> 33 templates across 11 industries</li>
                    <li><strong>Code Fragment URIs:</strong> db://, s3://, file:// schemes</li>
                    <li><strong>Industries:</strong> Banking, Healthcare, Legal, HR, Technology</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">MCP Layer (Enhanced)</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>MCPServerManager:</strong> Server lifecycle management</li>
                    <li><strong>MCPServerConfig:</strong> Server configuration model</li>
                    <li><strong>HTTPMCPClient:</strong> HTTP protocol client</li>
                    <li><strong>WebSocketMCPClient:</strong> WebSocket protocol client</li>
                    <li><strong>Auto-connect:</strong> Automatic server connection on startup</li>
                    <li><strong>Health Monitoring:</strong> Background health checks</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<h2 id="ai-org">AI Organizations <span class="badge bg-info">v1.4.5</span></h2>
<div class="row g-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">AI Org Manager</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>Hierarchical Structures:</strong> Model corporate org charts with AI agents</li>
                    <li><strong>Node Types:</strong> Executive, Manager, Analyst, Coordinator roles</li>
                    <li><strong>Task Delegation:</strong> Automatic subtask assignment to subordinates</li>
                    <li><strong>Response Aggregation:</strong> AI synthesizes subordinate responses</li>
                    <li><strong>Delegation Strategies:</strong> Parallel, Sequential, Conditional</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Human Mirror System</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>Human Mirror:</strong> Each AI node represents a real employee</li>
                    <li><strong>Notification Preferences:</strong> Per-node Email/Teams/Slack settings</li>
                    <li><strong>HITL Integration:</strong> Human approval at any hierarchy level</li>
                    <li><strong>Override Capability:</strong> Humans can modify AI outputs</li>
                    <li><strong>Audit Trail:</strong> Complete history of all interventions</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<h2 id="notifications">Enterprise Notifications <span class="badge bg-warning text-dark">v1.4.0</span></h2>
<div class="row g-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">NotificationManager</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>Multi-Channel Routing:</strong> Single API, multiple destinations</li>
                    <li><strong>Rate Limiting:</strong> Token bucket algorithm per channel</li>
                    <li><strong>Retry Logic:</strong> Exponential backoff for failed deliveries</li>
                    <li><strong>Priority Levels:</strong> Debug, Info, Success, Warning, Error, Critical</li>
                    <li><strong>Audit Logging:</strong> Complete notification history in DB</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Channel Adapters</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>Slack Adapter:</strong> Block Kit, channels, DMs, threads</li>
                    <li><strong>Teams Adapter:</strong> Adaptive Cards, webhooks, actions</li>
                    <li><strong>Email Adapter:</strong> SMTP with HTML templates</li>
                    <li><strong>Webhook Receiver:</strong> HMAC/JWT/API key authentication</li>
                    <li><strong>Replay Protection:</strong> Nonce and timestamp validation</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<h2 id="swarms">Agent Swarms <span class="badge bg-danger">v1.3.0</span></h2>
<div class="row g-4">
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">SwarmManager</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>Master Actor:</strong> LLM-powered orchestration of agent coordination</li>
                    <li><strong>Event Bus:</strong> Internal pub/sub messaging between agents</li>
                    <li><strong>Agent Pools:</strong> Pre-warmed agent instances with round-robin selection</li>
                    <li><strong>Choreography:</strong> Dynamic task assignment based on LLM decisions</li>
                    <li><strong>Visual Designer:</strong> Drag-and-drop swarm building interface</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">External Triggers</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li><strong>Apache Kafka:</strong> Topic-based message consumption</li>
                    <li><strong>RabbitMQ:</strong> Queue-based message processing</li>
                    <li><strong>HTTP Webhooks:</strong> REST endpoint triggers</li>
                    <li><strong>Scheduled:</strong> Cron-based periodic execution</li>
                    <li><strong>User Query:</strong> Direct user-initiated requests</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<h2 id="database">Database Schema</h2>
<p>33+ tables supporting the complete data model:</p>

<pre><code class="language-sql">-- Core Tables
users              -- User accounts and authentication
roles              -- Role definitions
user_roles         -- User-role assignments
sessions           -- Active sessions
api_keys           -- API key authentication

-- Agent Tables
agents             -- Agent definitions
agent_versions     -- Version history
agent_templates    -- Reusable templates

-- Workflow Tables
workflows          -- Workflow definitions
workflow_nodes     -- Node configurations

-- Code Management
code_fragments     -- Reusable code modules (db:// URIs)
                   -- fragment_id, name, code, version
                   -- category, tags, dependencies
                   -- usage_count, is_active

-- LLM Management
llm_providers      -- Provider configurations
llm_models         -- Model definitions with costs
model_permissions  -- RBAC for model access

-- Execution Tables
executions         -- Execution records
execution_steps    -- Per-node execution data
llm_calls          -- LLM interaction logs

-- HITL Tables
hitl_tasks         -- Human review tasks

-- MCP Tables
mcp_plugins        -- Plugin registry

-- Notification Tables (v1.4.0)
notification_channels     -- Slack/Teams/Email/Webhook configs
notification_logs         -- Complete notification history
webhook_endpoints         -- Registered webhook receivers
webhook_events            -- Received webhook events
user_notification_preferences  -- Per-user delivery settings

-- AI Organization Tables (v1.4.5)
ai_orgs            -- Organization metadata and config
ai_nodes           -- Hierarchical nodes with roles
ai_tasks           -- Task delegation and tracking
ai_responses       -- Node responses with quality scores
ai_hitl_actions    -- Human intervention audit trail
ai_event_logs      -- Organization event history

-- System Tables
audit_logs         -- Activity audit trail
system_settings    -- Configuration settings</code></pre>

<hr class="my-5">

<h2 id="workflow-engine">Workflow Execution Engine</h2>
<pre><code class="language-text">┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  JSON DAG    │───▶│  DAG Parser  │───▶│ DAGWorkflow  │
│  Definition  │    │              │    │   Object     │
└──────────────┘    └──────────────┘    └──────────────┘
                                               │
                                               ▼
                    ┌──────────────────────────────────┐
                    │       Workflow Executor          │
                    │  ┌──────────────────────────┐   │
                    │  │ 1. Load Python Modules   │   │
                    │  │    (Resolve URIs)        │   │
                    │  │ 2. Topological Sort      │   │
                    │  │ 3. For each node:        │   │
                    │  │    - Resolve deps        │   │
                    │  │    - Execute node        │   │
                    │  │    - Log step            │   │
                    │  │ 4. Return final output   │   │
                    │  └──────────────────────────┘   │
                    └──────────────────────────────────┘
                                               │
                                               ▼
                    ┌──────────────────────────────────┐
                    │         Execution Record         │
                    │  - Status, Duration, Tokens      │
                    │  - Input/Output Data             │
                    │  - Step-by-step Trace            │
                    └──────────────────────────────────┘</code></pre>

<hr class="my-5">

<h2 id="code-loader">Code Loader (URI Resolution)</h2>
<p>The CodeLoader utility resolves code from multiple sources at workflow runtime:</p>

<pre><code class="language-text">┌─────────────────────────────────────────────────────────────────┐
│                        CODE LOADER                               │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Input: "db://data-utils" or "file://..." or "s3://..."    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                             │                                    │
│          ┌──────────────────┼──────────────────┐                │
│          ▼                  ▼                  ▼                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   db://      │  │   file://    │  │    s3://     │          │
│  │ ─────────── │  │ ─────────── │  │ ─────────── │          │
│  │ Query       │  │ Read from   │  │ boto3        │          │
│  │ code_       │  │ filesystem  │  │ get_object() │          │
│  │ fragments   │  │             │  │              │          │
│  │ table       │  │             │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│          │                  │                  │                │
│          └──────────────────┼──────────────────┘                │
│                             ▼                                    │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │ Output: Python code string (cached for performance)       │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘</code></pre>

<pre><code class="language-python">class CodeLoader:
    """Load Python code from various URI sources."""
    
    def load(self, uri: str) -> Optional[str]:
        """
        Resolve URI and return code string.
        
        Supported schemes:
        - db://fragment_id  → Query code_fragments table
        - file:///path      → Read from filesystem
        - s3://bucket/key   → Fetch from AWS S3
        - (inline code)     → Return as-is
        """
        scheme = urlparse(uri).scheme
        
        if scheme == 'db':
            return self._load_from_db(fragment_id)
        elif scheme == 'file':
            return self._load_from_file(path)
        elif scheme == 's3':
            return self._load_from_s3(bucket, key)
        else:
            return uri  # Treat as inline code
    
    def resolve_uri(self, uri_or_code: str) -> str:
        """Smart resolution: detect if URI or inline code."""
        if uri_or_code.startswith(('db://', 'file://', 's3://')):
            return self.load(uri_or_code)
        return uri_or_code</code></pre>

<hr class="my-5">

<h2 id="llm-facade">LLM Facade Pattern</h2>
<p>Unified interface for all LLM providers with automatic logging:</p>

<pre><code class="language-python">class LLMFacade:
    def complete(self, messages, provider, model, **kwargs):
        """
        1. Select provider client
        2. Make API call
        3. Log to llm_calls table:
           - Provider, model
           - Prompts, response
           - Tokens (input/output)
           - Cost estimate
           - Latency
        4. Return response
        """
        
        start_time = time.time()
        response = self._call_provider(provider, model, messages)
        latency_ms = (time.time() - start_time) * 1000
        
        # Auto-log to database
        self._log_call(
            provider=provider,
            model=model,
            input_tokens=response.input_tokens,
            output_tokens=response.output_tokens,
            cost=self._estimate_cost(provider, model, tokens),
            latency_ms=latency_ms
        )
        
        return response</code></pre>

<div class="text-center mt-5">
    <a href="{{ url_for('about') }}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left me-2"></i>Back to About
    </a>
</div>
{% endblock %}
