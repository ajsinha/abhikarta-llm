{% extends "base.html" %}

{% block title %}Webhook Endpoint: {{ endpoint.name }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-link-45deg me-2 text-info"></i>{{ endpoint.name }}</h2>
            <p class="text-muted mb-0">{{ endpoint.description or 'Webhook endpoint details and event history' }}</p>
        </div>
        <div>
            <a href="{{ url_for('webhook_edit', endpoint_id=endpoint.endpoint_id) }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-pencil me-1"></i>Edit
            </a>
            <a href="{{ url_for('webhook_endpoints') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Back
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Endpoint Details -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Endpoint Details</h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Status</dt>
                        <dd class="col-sm-8">
                            {% if endpoint.is_active %}
                            <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Active</span>
                            {% else %}
                            <span class="badge bg-secondary"><i class="bi bi-x-circle me-1"></i>Inactive</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-4">URL</dt>
                        <dd class="col-sm-8">
                            <code class="small">{{ request.url_root }}api/webhooks/{{ endpoint.path }}</code>
                            <button class="btn btn-sm btn-link p-0 ms-1" onclick="copyUrl()" title="Copy URL">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </dd>
                        
                        <dt class="col-sm-4">Auth</dt>
                        <dd class="col-sm-8">
                            {% if endpoint.auth_method == 'hmac' %}
                            <span class="badge bg-primary">HMAC-SHA256</span>
                            {% elif endpoint.auth_method == 'jwt' %}
                            <span class="badge bg-info">JWT</span>
                            {% elif endpoint.auth_method == 'api_key' %}
                            <span class="badge bg-warning text-dark">API Key</span>
                            {% elif endpoint.auth_method == 'basic' %}
                            <span class="badge bg-secondary">Basic Auth</span>
                            {% else %}
                            <span class="badge bg-danger">None</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-4">Target</dt>
                        <dd class="col-sm-8">
                            {% if endpoint.target_type %}
                            <span class="badge bg-secondary">{{ endpoint.target_type }}</span>
                            <br><small class="text-muted">{{ endpoint.target_id }}</small>
                            {% else %}
                            <small class="text-muted">Manual handler</small>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-4">Rate Limit</dt>
                        <dd class="col-sm-8">{{ endpoint.rate_limit or 100 }} req/min</dd>
                        
                        <dt class="col-sm-4">Created</dt>
                        <dd class="col-sm-8">
                            <small class="text-muted">{{ endpoint.created_at|dt(19) if endpoint.created_at else 'N/A' }}</small>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Event Stats -->
        <div class="col-lg-8 mb-4">
            <div class="row g-3 mb-3">
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-0">Verified</h6>
                                    <h3 class="mb-0">{{ events|selectattr('verified')|list|length }}</h3>
                                </div>
                                <i class="bi bi-shield-check fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-0">Processed</h6>
                                    <h3 class="mb-0">{{ events|selectattr('processed')|list|length }}</h3>
                                </div>
                                <i class="bi bi-check-all fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-info text-white">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-white-50 mb-0">Total Events</h6>
                                    <h3 class="mb-0">{{ events|length }}</h3>
                                </div>
                                <i class="bi bi-arrow-down-circle fs-1 opacity-50"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Events -->
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>Recent Events</h5>
                    <a href="{{ url_for('webhook_events', endpoint_id=endpoint.endpoint_id) }}" class="btn btn-sm btn-outline-info">
                        View All
                    </a>
                </div>
                <div class="card-body p-0">
                    {% if events %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Time</th>
                                    <th>Event Type</th>
                                    <th>Verified</th>
                                    <th>Processed</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for event in events[:10] %}
                                <tr>
                                    <td><small class="text-muted">{{ event.received_at|dt(19) if event.received_at else 'N/A' }}</small></td>
                                    <td>
                                        {% if event.event_type %}
                                        <code>{{ event.event_type }}</code>
                                        {% else %}
                                        <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if event.verified %}
                                        <span class="badge bg-success"><i class="bi bi-check"></i></span>
                                        {% else %}
                                        <span class="badge bg-danger"><i class="bi bi-x"></i></span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if event.processed %}
                                        <span class="badge bg-success"><i class="bi bi-check"></i></span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark"><i class="bi bi-hourglass"></i></span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        <button class="btn btn-sm btn-outline-info" onclick="showEventDetail('{{ event.event_id }}')" title="Details">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <p class="text-muted mt-2 mb-0">No events received yet</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Test Endpoint -->
    <div class="card border-warning">
        <div class="card-body">
            <h6><i class="bi bi-lightning me-2 text-warning"></i>Test Endpoint</h6>
            <p class="text-muted small mb-2">Send a test webhook to verify the endpoint is working.</p>
            <button class="btn btn-warning btn-sm" onclick="testEndpoint()">
                <i class="bi bi-send me-1"></i>Send Test Webhook
            </button>
        </div>
    </div>
</div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventDetailBody">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyUrl() {
    const url = '{{ request.url_root }}api/webhooks/{{ endpoint.path }}';
    navigator.clipboard.writeText(url).then(() => {
        alert('Webhook URL copied to clipboard!');
    });
}

async function testEndpoint() {
    try {
        const response = await fetch(`/api/webhooks/test/{{ endpoint.endpoint_id }}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            alert('Test webhook sent successfully!');
            location.reload();
        } else {
            alert('Test failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function showEventDetail(eventId) {
    const modal = new bootstrap.Modal(document.getElementById('eventDetailModal'));
    const body = document.getElementById('eventDetailBody');
    
    body.innerHTML = '<div class="text-center"><div class="spinner-border text-info"></div></div>';
    modal.show();
    
    try {
        const response = await fetch(`/api/webhooks/event/${eventId}`);
        const event = await response.json();
        
        body.innerHTML = `
            <dl class="row">
                <dt class="col-sm-3">Event ID</dt>
                <dd class="col-sm-9"><code>${event.event_id}</code></dd>
                
                <dt class="col-sm-3">Event Type</dt>
                <dd class="col-sm-9"><code>${event.event_type || 'Not specified'}</code></dd>
                
                <dt class="col-sm-3">Source IP</dt>
                <dd class="col-sm-9">${event.source_ip || 'Unknown'}</dd>
                
                <dt class="col-sm-3">Verified</dt>
                <dd class="col-sm-9">${event.verified ? '✅ Yes' : '❌ No'}</dd>
                
                <dt class="col-sm-3">Processed</dt>
                <dd class="col-sm-9">${event.processed ? '✅ Yes' : '⏳ Pending'}</dd>
                
                <dt class="col-sm-3">Received</dt>
                <dd class="col-sm-9">${event.received_at || 'N/A'}</dd>
            </dl>
            
            <h6>Payload</h6>
            <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow: auto;">${JSON.stringify(event.payload || {}, null, 2)}</pre>
        `;
    } catch (error) {
        body.innerHTML = `<div class="alert alert-danger">Error loading details: ${error.message}</div>`;
    }
}
</script>
{% endblock %}
