{% extends "base.html" %}

{% block title %}Create Webhook Endpoint - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="bi bi-plus-circle me-2 text-info"></i>Create Webhook Endpoint</h2>
                    <p class="text-muted mb-0">Configure a new endpoint to receive external webhooks</p>
                </div>
                <a href="{{ url_for('webhook_endpoints') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back
                </a>
            </div>

            <!-- Create Form -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="bi bi-link-45deg me-2"></i>Endpoint Configuration</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <!-- Basic Info -->
                        <h6 class="text-muted mb-3">Basic Information</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Endpoint Name <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control" required
                                   placeholder="e.g., GitHub Webhook">
                            <div class="form-text">A descriptive name for this endpoint</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Path <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text"><code>/api/webhooks/</code></span>
                                <input type="text" name="path" class="form-control" required
                                       placeholder="github" pattern="[a-z0-9-_]+"
                                       title="Lowercase letters, numbers, hyphens, underscores only">
                            </div>
                            <div class="form-text">URL path for this endpoint (lowercase, no spaces)</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea name="description" class="form-control" rows="2"
                                      placeholder="Receives push events from GitHub repository"></textarea>
                        </div>

                        <hr>

                        <!-- Authentication -->
                        <h6 class="text-muted mb-3">Authentication</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Authentication Method <span class="text-danger">*</span></label>
                            <select name="auth_method" class="form-select" id="authMethod" onchange="toggleAuthFields()">
                                <option value="hmac">HMAC-SHA256 Signature</option>
                                <option value="jwt">JWT Token</option>
                                <option value="api_key">API Key</option>
                                <option value="basic">Basic Auth</option>
                                <option value="none">None (Not Recommended)</option>
                            </select>
                            <div class="form-text">How to verify incoming requests</div>
                        </div>

                        <div class="mb-3" id="secretField">
                            <label class="form-label">Secret Key <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" name="secret" class="form-control" id="secretInput"
                                       placeholder="Enter a secure secret or generate one">
                                <button type="button" class="btn btn-outline-secondary" onclick="generateSecret()">
                                    <i class="bi bi-dice-5"></i> Generate
                                </button>
                            </div>
                            <div class="form-text">
                                <span id="secretHelp">Used to sign/verify webhook payloads</span>
                            </div>
                        </div>

                        <hr>

                        <!-- Target (Optional) -->
                        <h6 class="text-muted mb-3">Target Action (Optional)</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Target Type</label>
                            <select name="target_type" class="form-select" id="targetType" onchange="toggleTargetId()">
                                <option value="">Manual Handler (Custom Code)</option>
                                <option value="agent">Trigger Agent</option>
                                <option value="workflow">Trigger Workflow</option>
                                <option value="swarm">Trigger Swarm</option>
                            </select>
                            <div class="form-text">Automatically trigger an agent, workflow, or swarm</div>
                        </div>

                        <div class="mb-3" id="targetIdField" style="display: none;">
                            <label class="form-label">Target ID</label>
                            <input type="text" name="target_id" class="form-control" id="targetIdInput"
                                   placeholder="agent-123 or workflow-456">
                            <div class="form-text">The ID of the agent, workflow, or swarm to trigger</div>
                        </div>

                        <hr>

                        <!-- Rate Limiting -->
                        <h6 class="text-muted mb-3">Rate Limiting</h6>
                        
                        <div class="mb-3">
                            <label class="form-label">Rate Limit (requests/minute)</label>
                            <input type="number" name="rate_limit" class="form-control" value="100" min="1" max="10000">
                            <div class="form-text">Maximum requests per minute from this endpoint</div>
                        </div>

                        <hr>
                        
                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('webhook_endpoints') }}" class="btn btn-outline-secondary me-2">Cancel</a>
                            <button type="submit" class="btn btn-info">
                                <i class="bi bi-check-lg me-1"></i>Create Endpoint
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Help Card -->
            <div class="card border-info mt-4">
                <div class="card-body">
                    <h6><i class="bi bi-lightbulb me-2 text-info"></i>Authentication Tips</h6>
                    <ul class="mb-0 small">
                        <li><strong>HMAC-SHA256:</strong> Best for GitHub, Stripe, Slack webhooks. Configure the secret in the external system.</li>
                        <li><strong>JWT:</strong> For systems that send JWT bearer tokens. Validates token signature.</li>
                        <li><strong>API Key:</strong> Simple header-based auth. External system sends <code>X-API-Key</code> header.</li>
                        <li><strong>Basic Auth:</strong> HTTP Basic authentication with username:password.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleAuthFields() {
    const method = document.getElementById('authMethod').value;
    const secretField = document.getElementById('secretField');
    const secretHelp = document.getElementById('secretHelp');
    
    if (method === 'none') {
        secretField.style.display = 'none';
    } else {
        secretField.style.display = 'block';
        
        switch(method) {
            case 'hmac':
                secretHelp.textContent = 'Used to verify HMAC-SHA256 signatures';
                break;
            case 'jwt':
                secretHelp.textContent = 'Secret key for JWT verification';
                break;
            case 'api_key':
                secretHelp.textContent = 'The API key that clients must send in X-API-Key header';
                break;
            case 'basic':
                secretHelp.textContent = 'Format: username:password';
                break;
        }
    }
}

function toggleTargetId() {
    const targetType = document.getElementById('targetType').value;
    const targetIdField = document.getElementById('targetIdField');
    
    targetIdField.style.display = targetType ? 'block' : 'none';
}

function generateSecret() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let secret = '';
    for (let i = 0; i < 32; i++) {
        secret += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('secretInput').value = secret;
}
</script>
{% endblock %}
