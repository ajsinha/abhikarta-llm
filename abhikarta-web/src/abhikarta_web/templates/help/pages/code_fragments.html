{% extends "help/help_base.html" %}

{% set title = "Code Fragments" %}
{% set description = "Reusable Python modules with standard import syntax" %}
{% set icon = "bi-code-square" %}
{% set header_color = "#6f42c1" %}
{% set header_color_dark = "#59359a" %}

{% block help_nav %}
<a href="#overview">Overview</a>
<a href="#import-syntax">Import Syntax</a>
<a href="#sync-service">Sync Service</a>
<a href="#creating">Creating Fragments</a>
<a href="#approval">Approval Workflow</a>
<a href="#configuration">Configuration</a>
<a href="#best-practices">Best Practices</a>
{% endblock %}

{% block help_content %}
<h2 id="overview">Overview</h2>
<p class="lead">Code Fragments are reusable Python modules that are synced locally for standard imports. Once approved, use them like any Python package.</p>

<div class="alert alert-success">
    <i class="bi bi-lightbulb me-2"></i>
    <strong>v1.5.0 Update:</strong> Code fragments now use standard Python imports instead of URI schemes. 
    Approved fragments are automatically synced to a local <code>code_fragments</code> package.
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card border-success h-100">
            <div class="card-header bg-success text-white">
                <i class="bi bi-check-circle me-2"></i>New Way (v1.5.0+)
            </div>
            <div class="card-body">
<pre class="mb-0"><code class="language-python"># Standard Python import - IDE autocomplete works!
from code_fragments.data_validator import validate_email
from code_fragments.csv_parser import parse_csv

# Use functions directly
if validate_email(user_email):
    data = parse_csv(file_content)</code></pre>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card border-secondary h-100">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-archive me-2"></i>Legacy Way (Still Supported)
            </div>
            <div class="card-body">
<pre class="mb-0"><code class="language-json">{
  "python_modules": {
    "utils": "db://data-validator"
  }
}</code></pre>
                <small class="text-muted d-block mt-2">URI-based loading still works for backward compatibility.</small>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<h2 id="import-syntax">Import Syntax</h2>
<p>Once a code fragment is approved or published, it's synced to the local <code>code_fragments</code> package.</p>

<h5>Import Specific Functions (Recommended)</h5>
<pre><code class="language-python">from code_fragments.data_validator import validate_email, validate_required

if validate_email(email):
    errors = validate_required(form_data, required_fields)</code></pre>

<h5>Import Entire Module</h5>
<pre><code class="language-python">from code_fragments import data_validator

result = data_validator.validate_email("test@example.com")</code></pre>

<h5>In Workflow JSON</h5>
<pre><code class="language-json">{
  "nodes": {
    "validate": {
      "type": "python",
      "code": "from code_fragments.data_validator import validate_email\nresult = validate_email(input_data['email'])"
    }
  }
}</code></pre>

<hr class="my-5">

<h2 id="sync-service">Sync Service</h2>
<p>The <strong>CodeFragmentSyncService</strong> automatically syncs approved fragments to a local Python package.</p>

<div class="card mb-4">
    <div class="card-body">
<pre class="mb-0"><code>project_root/
└── code_fragments/
    └── src/
        └── code_fragments/
            ├── __init__.py            # Auto-generated exports
            ├── data_validator.py      # Synced fragment
            └── csv_parser.py          # Synced fragment</code></pre>
    </div>
</div>

<div class="row g-3">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="bi bi-arrow-repeat text-primary fs-3"></i>
                <h6 class="mt-2">Auto-Sync</h6>
                <p class="small mb-0">Every 5 minutes (configurable)</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="bi bi-hash text-success fs-3"></i>
                <h6 class="mt-2">Change Detection</h6>
                <p class="small mb-0">SHA256 checksums</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body text-center">
                <i class="bi bi-lightning text-warning fs-3"></i>
                <h6 class="mt-2">Hot Reload</h6>
                <p class="small mb-0">Graceful or immediate</p>
            </div>
        </div>
    </div>
</div>

<hr class="my-5">

<h2 id="creating">Creating Fragments</h2>
<ol>
    <li>Go to <strong>Playground → Code Fragments → Create Fragment</strong></li>
    <li>Enter a <strong>Display Name</strong> (e.g., "Data Validator")</li>
    <li>The <strong>Module Name</strong> is auto-generated (e.g., "data_validator")</li>
    <li>Write your Python code</li>
    <li>Save as Draft</li>
</ol>

<div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle me-2"></i>
    <strong>Module Name Rules:</strong> Must be a valid Python identifier (lowercase, underscores, no hyphens).
</div>

<h5>Example Fragment</h5>
<pre><code class="language-python">"""Data validation utilities."""

import re
from typing import Dict, List

def validate_email(email: str) -> bool:
    """Validate email address format."""
    pattern = r'^[\w\.-]+@[\w\.-]+\.\w+$'
    return bool(re.match(pattern, email or ''))

def validate_required(data: Dict, fields: List[str]) -> List[str]:
    """Return list of missing required fields."""
    return [f for f in fields if not data.get(f)]</code></pre>

<hr class="my-5">

<h2 id="approval">Approval Workflow</h2>

<div class="d-flex align-items-center justify-content-center my-4 flex-wrap gap-2">
    <span class="badge bg-secondary p-2">Draft</span>
    <i class="bi bi-arrow-right mx-2"></i>
    <span class="badge bg-info p-2">Testing</span>
    <i class="bi bi-arrow-right mx-2"></i>
    <span class="badge bg-warning text-dark p-2">Pending Review</span>
    <i class="bi bi-arrow-right mx-2"></i>
    <span class="badge bg-success p-2">Approved ✓</span>
    <i class="bi bi-arrow-right mx-2"></i>
    <span class="badge bg-primary p-2">Published ✓</span>
</div>

<p class="text-center text-muted">Only <span class="badge bg-success">Approved</span> and <span class="badge bg-primary">Published</span> fragments are synced for import.</p>

<hr class="my-5">

<h2 id="configuration">Configuration</h2>
<p>Configure the sync service in your <code>application.properties</code>:</p>
<pre><code class="language-properties"># Code Fragments Sync Configuration (v1.5.0)
code.fragments.enabled=true
code.fragments.target.path=./code_fragments
code.fragments.sync.interval.seconds=300
code.fragments.sync.on.startup=true
code.fragments.watch.enabled=true
code.fragments.status.filter=approved,published
code.fragments.reload.strategy=graceful
code.fragments.max.wait.seconds=30

# Optional: S3 source
code.fragments.s3.enabled=false
code.fragments.s3.bucket=
code.fragments.s3.prefix=

# Optional: Filesystem source
code.fragments.filesystem.enabled=false
code.fragments.filesystem.paths=</code></pre>

<hr class="my-5">

<h2 id="best-practices">Best Practices</h2>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card h-100 border-success">
            <div class="card-body">
                <h5 class="text-success"><i class="bi bi-check-circle me-2"></i>Do</h5>
                <ul class="mb-0">
                    <li>Use descriptive module names</li>
                    <li>Add docstrings to functions</li>
                    <li>Use type hints</li>
                    <li>Test before submitting</li>
                    <li>Keep fragments focused</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card h-100 border-danger">
            <div class="card-body">
                <h5 class="text-danger"><i class="bi bi-x-circle me-2"></i>Don't</h5>
                <ul class="mb-0">
                    <li>Put secrets in code</li>
                    <li>Use hyphens in names</li>
                    <li>Create circular dependencies</li>
                    <li>Skip approval workflow</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="text-center mt-5">
    <a href="{{ url_for('user_code_fragments') }}" class="btn btn-primary me-2">
        <i class="bi bi-folder me-2"></i>My Fragments
    </a>
    <a href="{{ url_for('browse_code_fragments') }}" class="btn btn-outline-primary me-2">
        <i class="bi bi-search me-2"></i>Browse All
    </a>
    <a href="{{ url_for('help') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Back to Help
    </a>
</div>
{% endblock %}
