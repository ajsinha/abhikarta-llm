{% extends "help/help_base.html" %}

{% block title %}Notifications - {{ app_name }}{% endblock %}

{% block help_content %}
<div class="help-content">
    <h1><i class="bi bi-bell me-2 text-warning"></i>Notification System</h1>
    <p class="lead">Send notifications to Slack, Teams, and receive external webhooks to trigger agents.</p>

    <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle me-2"></i>
        <strong>New in v1.4.0:</strong> Enterprise notification system with multi-channel support, webhook receiver, and full audit logging.
    </div>

    <hr>

    <h2 id="overview">Overview</h2>
    <p>The notification module enables bidirectional communication:</p>
    <ul>
        <li><strong>Outgoing:</strong> Send alerts to Slack, Microsoft Teams, Email from agents, workflows, and swarms</li>
        <li><strong>Incoming:</strong> Receive webhooks from GitHub, Stripe, Slack, etc. to trigger automated actions</li>
    </ul>

    <div class="row g-4 my-4">
        <div class="col-md-6">
            <div class="card h-100 border-success">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-arrow-up-circle text-success me-2"></i>Outgoing Notifications</h5>
                    <ul class="mb-0">
                        <li>Slack (channels, DMs, threads)</li>
                        <li>Microsoft Teams (Adaptive Cards)</li>
                        <li>Email (SMTP)</li>
                        <li>Webhook (POST to URLs)</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100 border-info">
                <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-arrow-down-circle text-info me-2"></i>Incoming Webhooks</h5>
                    <ul class="mb-0">
                        <li>GitHub (push, PR, issues)</li>
                        <li>Stripe (payments, subscriptions)</li>
                        <li>Slack (slash commands, events)</li>
                        <li>Custom integrations</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <h2 id="slack">Slack Integration</h2>
    
    <h4>Setup Steps:</h4>
    <ol>
        <li>Go to <a href="https://api.slack.com/apps" target="_blank">api.slack.com/apps</a> and create a new app</li>
        <li>Under "OAuth & Permissions", add these scopes:
            <ul>
                <li><code>chat:write</code> - Send messages</li>
                <li><code>chat:write.public</code> - Send to public channels</li>
                <li><code>users:read</code> - Look up users for DMs</li>
            </ul>
        </li>
        <li>Install the app to your workspace</li>
        <li>Copy the "Bot User OAuth Token" (starts with <code>xoxb-</code>)</li>
        <li>Add the token in Admin → Notifications → Add Channel → Slack</li>
    </ol>

    <div class="card bg-light mb-4">
        <div class="card-body">
            <h6>Example Usage in Agent:</h6>
            <pre class="mb-0"><code class="language-python"># Send notification from an agent
await notification_manager.send_to_slack(
    channel="#alerts",
    title="Task Complete",
    body="Analysis finished successfully",
    level="success"
)</code></pre>
        </div>
    </div>

    <hr>

    <h2 id="teams">Microsoft Teams Integration</h2>
    
    <h4>Setup Steps:</h4>
    <ol>
        <li>In Teams, go to the channel where you want notifications</li>
        <li>Click "..." → "Connectors" → "Incoming Webhook"</li>
        <li>Name the webhook and copy the URL</li>
        <li>Add the URL in Admin → Notifications → Add Channel → Teams</li>
    </ol>

    <div class="card bg-light mb-4">
        <div class="card-body">
            <h6>Adaptive Card Features:</h6>
            <ul class="mb-0">
                <li>Rich formatting with sections and facts</li>
                <li>Action buttons for quick responses</li>
                <li>Color-coded by notification level</li>
                <li>Expandable details sections</li>
            </ul>
        </div>
    </div>

    <hr>

    <h2 id="webhooks">Webhook Receiver</h2>
    
    <p>Register endpoints to receive external webhooks and trigger agents, workflows, or swarms.</p>

    <h4>Creating an Endpoint:</h4>
    <ol>
        <li>Go to Admin → Notifications → Webhook Endpoints</li>
        <li>Click "Add Endpoint"</li>
        <li>Configure:
            <ul>
                <li><strong>Path:</strong> URL path (e.g., <code>github</code> → <code>/api/webhooks/github</code>)</li>
                <li><strong>Auth Method:</strong> HMAC, JWT, API Key, or None</li>
                <li><strong>Target:</strong> Agent, Workflow, or Swarm to trigger</li>
            </ul>
        </li>
    </ol>

    <h4>Authentication Methods:</h4>
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Method</th>
                    <th>Header/Signature</th>
                    <th>Best For</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>HMAC-SHA256</code></td>
                    <td><code>X-Hub-Signature-256</code></td>
                    <td>GitHub, Stripe, Slack</td>
                </tr>
                <tr>
                    <td><code>JWT</code></td>
                    <td><code>Authorization: Bearer &lt;token&gt;</code></td>
                    <td>Custom integrations</td>
                </tr>
                <tr>
                    <td><code>API Key</code></td>
                    <td><code>X-API-Key: &lt;key&gt;</code></td>
                    <td>Simple integrations</td>
                </tr>
                <tr>
                    <td><code>Basic</code></td>
                    <td><code>Authorization: Basic &lt;base64&gt;</code></td>
                    <td>Legacy systems</td>
                </tr>
            </tbody>
        </table>
    </div>

    <hr>

    <h2 id="agent-integration">Integration with Agents</h2>

    <p>Agents can send notifications at any point during execution:</p>

    <div class="card bg-light mb-4">
        <div class="card-body">
            <pre class="mb-0"><code class="language-python">from abhikarta.notification import NotificationManager, NotificationMessage, NotificationLevel

# Initialize (usually injected)
notification_manager = NotificationManager(db_facade)
notification_manager.configure_slack(bot_token="xoxb-...")

# Send to multiple channels
await notification_manager.send(
    channels=["slack", "teams"],
    message=NotificationMessage(
        title="Analysis Complete",
        body="Processed 1,234 records with 99.2% accuracy",
        level=NotificationLevel.SUCCESS,
        source=self.agent_id,
        source_type="agent",
        metadata={"records": 1234, "accuracy": 99.2}
    )
)</code></pre>
        </div>
    </div>

    <hr>

    <h2 id="workflow-integration">Workflow Notification Node</h2>

    <p>Add notification nodes to workflows:</p>

    <div class="card bg-light mb-4">
        <div class="card-body">
            <pre class="mb-0"><code class="language-json">{% raw %}{
  "nodes": [
    {
      "node_id": "notify_complete",
      "node_type": "notification",
      "config": {
        "channels": ["slack", "teams"],
        "level": "success",
        "title": "ETL Pipeline Complete",
        "body": "Processed {{ context.record_count }} records",
        "metadata": {
          "pipeline": "{{ workflow_id }}",
          "duration": "{{ execution_time }}"
        }
      }
    }
  ]
}{% endraw %}</code></pre>
        </div>
    </div>

    <hr>

    <h2 id="best-practices">Best Practices</h2>

    <div class="row g-3">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-check-circle me-2"></i>Do
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Use appropriate notification levels</li>
                        <li>Include actionable information</li>
                        <li>Set up rate limiting</li>
                        <li>Configure quiet hours for non-critical alerts</li>
                        <li>Use HMAC authentication for webhooks</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-x-circle me-2"></i>Don't
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Send notifications for every small event</li>
                        <li>Include sensitive data in messages</li>
                        <li>Use "none" auth for public webhooks</li>
                        <li>Ignore failed notifications</li>
                        <li>Hard-code tokens in agent code</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <h2 id="troubleshooting">Troubleshooting</h2>

    <div class="accordion" id="troubleshootingAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue1">
                    Slack messages not sending
                </button>
            </h2>
            <div id="issue1" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                <div class="accordion-body">
                    <ul>
                        <li>Verify the bot token starts with <code>xoxb-</code></li>
                        <li>Ensure the bot is invited to the target channel</li>
                        <li>Check OAuth scopes include <code>chat:write</code></li>
                        <li>Test the channel from Admin → Notifications</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue2">
                    Webhook signature verification failing
                </button>
            </h2>
            <div id="issue2" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                <div class="accordion-body">
                    <ul>
                        <li>Verify the secret matches exactly in both systems</li>
                        <li>Check the signature header name (GitHub uses <code>X-Hub-Signature-256</code>)</li>
                        <li>Ensure the payload is not modified by proxies</li>
                        <li>Check timestamp validation (requests older than 5 minutes are rejected)</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#issue3">
                    Teams cards not rendering correctly
                </button>
            </h2>
            <div id="issue3" class="accordion-collapse collapse" data-bs-parent="#troubleshootingAccordion">
                <div class="accordion-body">
                    <ul>
                        <li>Verify the webhook URL is correct and active</li>
                        <li>Check that JSON payload is valid</li>
                        <li>Try using MessageCard format instead of Adaptive Card</li>
                        <li>Ensure card version is compatible (we use v1.4)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <div class="d-flex justify-content-between mt-4">
        <a href="{{ url_for('notification_channels') }}" class="btn btn-primary">
            <i class="bi bi-gear me-1"></i>Configure Notifications
        </a>
        <a href="{{ url_for('markdown_viewer', filename='NOTIFICATION_QUICKSTART') }}" class="btn btn-outline-secondary">
            <i class="bi bi-book me-1"></i>Full Documentation
        </a>
    </div>
</div>
{% endblock %}
