{% extends "base.html" %}

{% block title %}Create Python Script - {{ app_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
<style>
    .CodeMirror {
        height: 500px;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        font-size: 14px;
    }
    .entity-type-btn {
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        transition: all 0.2s;
    }
    .entity-type-btn:hover {
        transform: translateY(-2px);
    }
    .entity-type-btn.active {
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
    }
    .validation-result {
        margin-top: 1rem;
        padding: 1rem;
        border-radius: 0.375rem;
    }
    .validation-valid { background: #d1e7dd; border: 1px solid #badbcc; }
    .validation-invalid { background: #f8d7da; border: 1px solid #f5c2c7; }
    .template-item-card {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
    }
    .template-item-card:hover {
        border-color: #7952b3;
        background-color: #f8f9fa;
    }
    .template-item-card.selected {
        border-color: #7952b3;
        background-color: #f0e6ff;
    }
    .from-template-alert {
        background: linear-gradient(135deg, #667eea15, #764ba215);
        border-left: 4px solid #7952b3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="bi bi-file-earmark-code me-2"></i>
                Create {{ entity_type|title }} Script
            </h2>
            <p class="text-muted mb-0">Define your {{ entity_type }} using Python code</p>
        </div>
        <div>
            <a href="{{ url_for('script_templates') }}" class="btn btn-outline-primary me-2">
                <i class="bi bi-collection me-1"></i>Browse Templates
            </a>
            <a href="{{ url_for('list_scripts') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>Back to Scripts
            </a>
        </div>
    </div>
    
    {% if from_template %}
    <!-- From Template Alert -->
    <div class="alert from-template-alert mb-4">
        <div class="d-flex align-items-center">
            <i class="bi bi-file-earmark-code text-primary me-3" style="font-size: 1.5rem;"></i>
            <div class="flex-grow-1">
                <strong>Using Template: {{ from_template.name }}</strong>
                <p class="mb-0 small text-muted">{{ from_template.description }}</p>
            </div>
            <span class="badge bg-secondary">{{ from_template.entity_type|title }}</span>
            {% if from_template.agent_type %}
            <span class="badge bg-info ms-2">{{ from_template.agent_type }}</span>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Left Column: Form -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Script Settings</h5>
                </div>
                <div class="card-body">
                    <form id="scriptForm">
                        <input type="hidden" id="entityType" value="{{ entity_type }}">
                        
                        <div class="mb-3">
                            <label for="name" class="form-label">Name *</label>
                            <input type="text" class="form-control" id="name" required 
                                   placeholder="My {{ entity_type|title }} Script">
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="2" 
                                      placeholder="What does this {{ entity_type }} do?"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="entryPoint" class="form-label">Entry Point Variable</label>
                            <input type="text" class="form-control" id="entryPoint" value="__export__"
                                   placeholder="__export__">
                            <small class="text-muted">The variable name that holds the definition</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="tags" class="form-label">Tags</label>
                            <input type="text" class="form-control" id="tags" 
                                   placeholder="python-script, custom, production">
                            <small class="text-muted">Comma-separated tags</small>
                        </div>
                        
                        <hr>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-primary" onclick="validateCode()">
                                <i class="bi bi-check-circle me-2"></i>Validate
                            </button>
                            <button type="button" class="btn btn-primary" onclick="saveScript()">
                                <i class="bi bi-save me-2"></i>Save Script
                            </button>
                            <button type="button" class="btn btn-success" onclick="saveAndExecute()">
                                <i class="bi bi-play-fill me-2"></i>Save & Execute
                            </button>
                        </div>
                        
                        <div id="validationResult" class="validation-result d-none"></div>
                    </form>
                </div>
            </div>
            
            <!-- Entity Type Selection -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-collection me-2"></i>Entity Type</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-6">
                            <a href="{{ url_for('create_script', type='agent') }}" 
                               class="btn btn-outline-primary entity-type-btn w-100 {{ 'active' if entity_type == 'agent' }}">
                                <i class="bi bi-robot d-block mb-1" style="font-size: 1.5rem;"></i>
                                Agent
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('create_script', type='workflow') }}"
                               class="btn btn-outline-success entity-type-btn w-100 {{ 'active' if entity_type == 'workflow' }}">
                                <i class="bi bi-diagram-3 d-block mb-1" style="font-size: 1.5rem;"></i>
                                Workflow
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('create_script', type='swarm') }}"
                               class="btn btn-outline-warning entity-type-btn w-100 {{ 'active' if entity_type == 'swarm' }}">
                                <i class="bi bi-hive d-block mb-1" style="font-size: 1.5rem;"></i>
                                Swarm
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{{ url_for('create_script', type='aiorg') }}"
                               class="btn btn-outline-secondary entity-type-btn w-100 {{ 'active' if entity_type == 'aiorg' }}">
                                <i class="bi bi-building d-block mb-1" style="font-size: 1.5rem;"></i>
                                AI Org
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Templates -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Templates</h5>
                    <a href="{{ url_for('script_templates', type=entity_type) }}" class="btn btn-sm btn-outline-primary">
                        View All
                    </a>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="quickTemplates">
                        <div class="text-center py-3 text-muted small">
                            <i class="bi bi-hourglass-split me-1"></i>Loading templates...
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column: Code Editor -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-code-slash me-2"></i>Python Code</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="resetTemplate()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Reset Template
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="formatCode()">
                            <i class="bi bi-text-indent-left me-1"></i>Format
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <textarea id="codeEditor">{{ template_code|safe }}</textarea>
                </div>
            </div>
            
            <!-- Help Section -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Quick Help</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Required Structure</h6>
                            <ul class="small text-muted">
                                <li>Define an <code>__export__</code> variable with your definition</li>
                                <li>Import from <code>abhikarta.{{ entity_type }}</code></li>
                                <li>Use SDK classes for type safety</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Tips</h6>
                            <ul class="small text-muted">
                                <li>Validate before saving to catch errors</li>
                                <li>Use tags for organization</li>
                                <li>Custom tools can be defined inline</li>
                            </ul>
                        </div>
                    </div>
                    <a href="{{ url_for('help_page', page='python-script-mode') }}" class="btn btn-link btn-sm p-0">
                        <i class="bi bi-book me-1"></i>View Full Documentation
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script>
// Initialize CodeMirror
const editor = CodeMirror.fromTextArea(document.getElementById('codeEditor'), {
    mode: 'python',
    theme: 'dracula',
    lineNumbers: true,
    indentUnit: 4,
    tabSize: 4,
    indentWithTabs: false,
    lineWrapping: true,
    matchBrackets: true,
    autoCloseBrackets: true,
    extraKeys: {
        'Tab': function(cm) {
            cm.replaceSelection('    ', 'end');
        }
    }
});

const templateCode = `{{ template_code|replace('\n', '\\n')|replace("'", "\\'")|safe }}`;

function resetTemplate() {
    if (confirm('Reset to template? This will overwrite your current code.')) {
        editor.setValue(templateCode);
    }
}

function formatCode() {
    // Basic formatting - just ensure proper indentation
    const code = editor.getValue();
    editor.setValue(code);
}

function showValidationResult(isValid, message, warnings = []) {
    const resultDiv = document.getElementById('validationResult');
    resultDiv.classList.remove('d-none', 'validation-valid', 'validation-invalid');
    resultDiv.classList.add(isValid ? 'validation-valid' : 'validation-invalid');
    
    let html = `<strong>${isValid ? '✓ Valid' : '✗ Invalid'}</strong><br>${message}`;
    if (warnings.length > 0) {
        html += '<br><br><strong>Warnings:</strong><ul>';
        warnings.forEach(w => html += `<li>${w}</li>`);
        html += '</ul>';
    }
    resultDiv.innerHTML = html;
}

function validateCode() {
    const code = editor.getValue();
    const entityType = document.getElementById('entityType').value;
    
    fetch('/api/scripts/validate-code', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({code: code, entity_type: entityType})
    })
    .then(r => r.json())
    .then(data => {
        showValidationResult(
            data.validation_status === 'valid',
            data.message,
            data.warnings || []
        );
    })
    .catch(err => {
        showValidationResult(false, 'Error: ' + err.message);
    });
}

function saveScript() {
    const name = document.getElementById('name').value.trim();
    if (!name) {
        alert('Please enter a name for the script');
        return;
    }
    
    const data = {
        name: name,
        description: document.getElementById('description').value,
        entity_type: document.getElementById('entityType').value,
        script_content: editor.getValue(),
        entry_point: document.getElementById('entryPoint').value || '__export__',
        tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t)
    };
    
    fetch('/api/scripts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Script saved successfully!');
            window.location.href = `/scripts/${data.script_id}`;
        } else {
            alert('Error: ' + data.error);
            if (data.validation_status) {
                showValidationResult(false, data.error);
            }
        }
    })
    .catch(err => {
        alert('Error: ' + err.message);
    });
}

function saveAndExecute() {
    const name = document.getElementById('name').value.trim();
    if (!name) {
        alert('Please enter a name for the script');
        return;
    }
    
    const data = {
        name: name,
        description: document.getElementById('description').value,
        entity_type: document.getElementById('entityType').value,
        script_content: editor.getValue(),
        entry_point: document.getElementById('entryPoint').value || '__export__',
        tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t)
    };
    
    // First save
    fetch('/api/scripts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(saveData => {
        if (!saveData.success) {
            throw new Error(saveData.error);
        }
        
        // Then execute
        return fetch(`/api/scripts/${saveData.script_id}/execute`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        }).then(r => r.json()).then(execData => ({saveData, execData}));
    })
    .then(({saveData, execData}) => {
        if (execData.success) {
            alert('Script saved and executed successfully!\n\nOutput:\n' + JSON.stringify(execData.output, null, 2));
            window.location.href = `/scripts/${saveData.script_id}`;
        } else {
            alert('Script saved but execution failed:\n' + execData.error);
            window.location.href = `/scripts/${saveData.script_id}`;
        }
    })
    .catch(err => {
        alert('Error: ' + err.message);
    });
}

// Load quick templates
function loadQuickTemplates() {
    const entityType = document.getElementById('entityType').value;
    fetch(`/api/scripts/templates?type=${entityType}`)
        .then(r => r.json())
        .then(data => {
            const container = document.getElementById('quickTemplates');
            if (!data.success || !data.templates.length) {
                container.innerHTML = '<div class="text-center py-3 text-muted small">No templates available</div>';
                return;
            }
            
            container.innerHTML = data.templates.slice(0, 5).map(t => `
                <a href="/scripts/create-from-template/${t.template_id}" 
                   class="list-group-item list-group-item-action d-flex align-items-center">
                    <i class="${t.icon} me-2 text-primary"></i>
                    <div class="flex-grow-1">
                        <div class="fw-medium small">${t.name}</div>
                        <div class="text-muted" style="font-size: 0.75rem;">${t.description.substring(0, 50)}...</div>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                </a>
            `).join('');
        })
        .catch(err => {
            console.error('Error loading templates:', err);
            document.getElementById('quickTemplates').innerHTML = 
                '<div class="text-center py-3 text-muted small">Error loading templates</div>';
        });
}

// Load templates on page load
document.addEventListener('DOMContentLoaded', loadQuickTemplates);
</script>
{% endblock %}
