{% extends "base.html" %}

{% block title %}{{ template.name }} - Script Template - {{ app_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css">
<style>
    .CodeMirror {
        height: 500px;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        font-size: 13px;
    }
    .CodeMirror-scroll {
        overflow-y: auto !important;
    }
    .template-header {
        background: linear-gradient(135deg, #7952b3 0%, #5e3f8c 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    .template-icon {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        background: rgba(255,255,255,0.2);
    }
    .feature-badge {
        background: rgba(255,255,255,0.2);
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
        display: inline-block;
    }
    .info-card {
        border-left: 4px solid #7952b3;
    }
    .code-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Back Button -->
    <div class="mb-3">
        <a href="{{ url_for('script_templates') }}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Back to Templates
        </a>
    </div>

    <!-- Template Header -->
    <div class="template-header">
        <div class="row align-items-center">
            <div class="col-auto">
                <div class="template-icon">
                    <i class="{{ template.icon }}"></i>
                </div>
            </div>
            <div class="col">
                <h2 class="mb-2">{{ template.name }}</h2>
                <p class="mb-3 opacity-75">{{ template.description }}</p>
                <div>
                    {% if template.entity_type == 'agent' %}
                    <span class="feature-badge"><i class="bi bi-robot me-1"></i>Agent</span>
                    {% if template.agent_type %}
                    <span class="feature-badge"><i class="bi bi-gear me-1"></i>{{ template.agent_type|title }}</span>
                    {% endif %}
                    {% elif template.entity_type == 'workflow' %}
                    <span class="feature-badge"><i class="bi bi-diagram-3 me-1"></i>Workflow</span>
                    {% elif template.entity_type == 'swarm' %}
                    <span class="feature-badge"><i class="bi bi-hive me-1"></i>Swarm</span>
                    {% elif template.entity_type == 'aiorg' %}
                    <span class="feature-badge"><i class="bi bi-building me-1"></i>AI Organization</span>
                    {% endif %}
                    <span class="feature-badge"><i class="bi bi-speedometer2 me-1"></i>{{ template.difficulty|capitalize }}</span>
                    <span class="feature-badge"><i class="bi bi-folder me-1"></i>{{ template.category|title }}</span>
                </div>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('create_script_from_template', template_id=template.template_id) }}" 
                   class="btn btn-light btn-lg">
                    <i class="bi bi-plus-circle me-2"></i>Use This Template
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Info -->
        <div class="col-lg-4 mb-4">
            <!-- Tags -->
            <div class="card info-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-tags me-2"></i>Tags</h5>
                </div>
                <div class="card-body">
                    {% for tag in template.tags %}
                    <span class="badge bg-secondary me-1 mb-1">{{ tag }}</span>
                    {% endfor %}
                </div>
            </div>

            <!-- Features -->
            <div class="card info-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-star me-2"></i>Features</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Complete class definitions
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Type-safe dataclasses
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Custom execute() function
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Validation logic included
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Extensive comments
                        </li>
                        <li>
                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                            Production-ready structure
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card info-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('create_script_from_template', template_id=template.template_id) }}" 
                           class="btn btn-primary">
                            <i class="bi bi-plus-circle me-2"></i>Create Script from Template
                        </a>
                        <button class="btn btn-outline-secondary" onclick="copyToClipboard()">
                            <i class="bi bi-clipboard me-2"></i>Copy Code
                        </button>
                        <a href="{{ url_for('help_page', page='python-script-mode') }}" class="btn btn-outline-info">
                            <i class="bi bi-book me-2"></i>View Documentation
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Code -->
        <div class="col-lg-8">
            <div class="code-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">
                        <i class="bi bi-code-slash me-2"></i>Template Code
                    </h5>
                    <div>
                        <span class="text-muted small me-3">
                            {{ template.script_content|length }} characters
                        </span>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard()">
                            <i class="bi bi-clipboard me-1"></i>Copy
                        </button>
                    </div>
                </div>
                <textarea id="codeViewer">{{ template.script_content|safe }}</textarea>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
<script>
// Initialize CodeMirror for viewing
const editor = CodeMirror.fromTextArea(document.getElementById('codeViewer'), {
    mode: 'python',
    theme: 'dracula',
    lineNumbers: true,
    readOnly: true,
    lineWrapping: true
});

function copyToClipboard() {
    const code = editor.getValue();
    navigator.clipboard.writeText(code).then(function() {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(function(err) {
        console.error('Failed to copy: ', err);
        alert('Failed to copy code to clipboard');
    });
}
</script>
{% endblock %}
