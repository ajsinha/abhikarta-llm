{% extends "base.html" %}

{% block title %}Execution Log - {{ execution.execution_id[:8] if execution else 'Unknown' }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-file-alt me-2"></i>Execution Log</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('user_dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('user_executions') }}">Executions</a></li>
                    {% if execution %}
                    <li class="breadcrumb-item"><a href="{{ url_for('execution_detail', execution_id=execution.execution_id) }}">{{ execution.execution_id[:8] }}...</a></li>
                    {% endif %}
                    <li class="breadcrumb-item active">Log</li>
                </ol>
            </nav>
        </div>
        <div>
            {% if execution %}
            <a href="{{ url_for('execution_trace', execution_id=execution.execution_id) }}" class="btn btn-outline-primary me-2">
                <i class="fas fa-project-diagram me-1"></i>View Trace
            </a>
            <a href="{{ url_for('execution_detail', execution_id=execution.execution_id) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Detail
            </a>
            {% else %}
            <a href="{{ url_for('user_executions') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Executions
            </a>
            {% endif %}
        </div>
    </div>
    
    {% if execution %}
    <!-- Execution Info Card -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-info-circle me-2"></i>Execution Information
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <strong>Execution ID:</strong><br>
                    <code>{{ execution.execution_id }}</code>
                </div>
                <div class="col-md-3">
                    <strong>Entity Type:</strong><br>
                    <span class="badge bg-{{ 'primary' if entity_type == 'workflow' else 'success' if entity_type == 'agent' else 'info' if entity_type == 'swarm' else 'warning' }}">
                        {{ entity_type|capitalize if entity_type else 'Unknown' }}
                    </span>
                </div>
                <div class="col-md-3">
                    <strong>Status:</strong><br>
                    {% set status = execution.status|default('unknown') if execution else 'unknown' %}
                    <span class="badge bg-{{ 'success' if status == 'completed' else 'danger' if status == 'failed' else 'warning' if status == 'running' else 'secondary' }}">
                        {{ status|capitalize }}
                    </span>
                </div>
                <div class="col-md-3">
                    <strong>Started:</strong><br>
                    {{ execution.started_at_formatted|default('N/A') }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Log Content -->
    {% if log_found and log_content %}
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-scroll me-2"></i>Execution Log Contents</span>
            <div>
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="copyLogContent()">
                    <i class="fas fa-copy me-1"></i>Copy
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="downloadLog()">
                    <i class="fas fa-download me-1"></i>Download
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <pre id="logContent" class="mb-0 p-3" style="max-height: 70vh; overflow: auto; background: #f8f9fa; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word;">{{ log_content }}</pre>
        </div>
    </div>
    
    {% else %}
    <!-- Log Not Found -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-file-excel fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Execution Log Not Available</h5>
            
            {% if log_error %}
            <div class="alert alert-warning d-inline-block text-start" style="max-width: 700px;">
                <pre class="mb-0" style="white-space: pre-wrap; font-size: 0.85rem;">{{ log_error }}</pre>
            </div>
            {% else %}
            <p class="text-muted mb-4">
                No execution log file was found for this execution.
            </p>
            {% endif %}
            
            <div class="alert alert-info d-inline-block text-start mt-3" style="max-width: 600px;">
                <h6><i class="fas fa-info-circle me-2"></i>About Execution Logs</h6>
                <p class="mb-2">Execution logs provide detailed debugging information including:</p>
                <ul class="mb-2">
                    <li><strong>User Input</strong> - Complete input data provided</li>
                    <li><strong>Entity Configuration</strong> - Workflow/agent settings</li>
                    <li><strong>LLM Configuration</strong> - Provider, model, temperature (API keys masked)</li>
                    <li><strong>Entity Definition</strong> - Full JSON being executed</li>
                    <li><strong>Node Executions</strong> - Step-by-step with inputs/outputs</li>
                    <li><strong>LLM Calls</strong> - Each API call with prompt/response</li>
                    <li><strong>Output/Error</strong> - Final result or error with traceback</li>
                </ul>
                <hr>
                <p class="mb-0 small">
                    <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                    <strong>Why might the log be missing?</strong>
                </p>
                <ul class="small mb-0 mt-2">
                    <li>This execution was created before v1.5.1 (when logging was added)</li>
                    <li>Execution logging may be disabled in <code>application.properties</code></li>
                    <li>The log file may have been deleted (check retention settings)</li>
                    <li>There may have been an error during execution that prevented logging</li>
                </ul>
            </div>
            
            <div class="mt-4">
                {% if execution %}
                <a href="{{ url_for('execution_trace', execution_id=execution.execution_id) }}" class="btn btn-primary me-2">
                    <i class="fas fa-project-diagram me-1"></i>View Execution Trace
                </a>
                <a href="{{ url_for('execution_detail', execution_id=execution.execution_id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-eye me-1"></i>View Execution Details
                </a>
                {% else %}
                <a href="{{ url_for('user_executions') }}" class="btn btn-primary">
                    <i class="fas fa-list me-1"></i>Back to Executions
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if log_found and log_content %}
<script>
function copyLogContent() {
    const logContent = document.getElementById('logContent');
    if (!logContent) {
        alert('Log content not found');
        return;
    }
    navigator.clipboard.writeText(logContent.textContent).then(() => {
        // Show temporary feedback
        const btn = event.target.closest('button');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy to clipboard');
    });
}

function downloadLog() {
    const logContent = document.getElementById('logContent');
    if (!logContent) {
        alert('Log content not found');
        return;
    }
    const content = logContent.textContent;
    const blob = new Blob([content], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = '{{ execution.execution_id if execution else "execution" }}.log';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>

<style>
#logContent {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
    line-height: 1.5;
}
</style>
{% endif %}
{% endblock %}
