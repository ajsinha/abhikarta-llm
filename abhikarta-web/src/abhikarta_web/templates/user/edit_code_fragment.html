{% extends "base.html" %}

{% block title %}Edit {{ fragment.name }} - Code Fragment - {{ app_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
<style>
    .CodeMirror {
        height: 400px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('user_code_fragments') }}">Code Fragments</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('user_view_code_fragment', fragment_id=fragment.fragment_id) }}">{{ fragment.name }}</a></li>
                    <li class="breadcrumb-item active">Edit</li>
                </ol>
            </nav>
            <h2><i class="bi bi-pencil-square me-2"></i>Edit Code Fragment</h2>
            <p class="text-muted">Modify your code fragment (current version: {{ fragment.version or '1.0.0' }})</p>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-8">
            <form method="POST" action="{{ url_for('user_edit_code_fragment', fragment_id=fragment.fragment_id) }}">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-info-circle me-2"></i>Fragment Details
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="name" class="form-label">Name <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" required
                                       value="{{ fragment.name }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="language" class="form-label">Language</label>
                                <select class="form-select" id="language" name="language">
                                    <option value="python" {% if fragment.language == 'python' %}selected{% endif %}>Python</option>
                                    <option value="javascript" {% if fragment.language == 'javascript' %}selected{% endif %}>JavaScript</option>
                                    <option value="shell" {% if fragment.language == 'shell' %}selected{% endif %}>Shell/Bash</option>
                                    <option value="sql" {% if fragment.language == 'sql' %}selected{% endif %}>SQL</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="2">{{ fragment.description or '' }}</textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="category" class="form-label">Category</label>
                                <input type="text" class="form-control" id="category" name="category" 
                                       list="category-list" value="{{ fragment.category or 'general' }}">
                                <datalist id="category-list">
                                    {% for cat in categories %}
                                    <option value="{{ cat }}">
                                    {% endfor %}
                                    <option value="general">
                                    <option value="data">
                                    <option value="utils">
                                    <option value="api">
                                    <option value="validation">
                                    <option value="transformation">
                                </datalist>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="version" class="form-label">Version</label>
                                <input type="text" class="form-control" id="version" name="version" 
                                       value="{{ fragment.version or '1.0.0' }}" readonly>
                                <small class="text-muted">Auto-incremented on save</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="tags" class="form-label">Tags</label>
                                {% set tags_str = fragment.tags if fragment.tags is string else (fragment.tags|join(', ') if fragment.tags else '') %}
                                <input type="text" class="form-control" id="tags" name="tags"
                                       value="{{ tags_str }}" placeholder="comma, separated, tags">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="dependencies" class="form-label">Dependencies</label>
                            {% set deps_str = fragment.dependencies if fragment.dependencies is string else (fragment.dependencies|join(', ') if fragment.dependencies else '') %}
                            <input type="text" class="form-control" id="dependencies" name="dependencies"
                                   value="{{ deps_str }}" placeholder="comma, separated, package names">
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-code-slash me-2"></i>Code <span class="text-danger">*</span></span>
                        <select class="form-select form-select-sm" style="width: auto;" id="themeSelect" onchange="changeTheme()">
                            <option value="default">Light Theme</option>
                            <option value="monokai" selected>Dark Theme</option>
                        </select>
                    </div>
                    <div class="card-body p-0">
                        <textarea id="code" name="code" style="display: none;"></textarea>
                        <div id="codeEditor"></div>
                    </div>
                </div>
                
                <div class="mt-4 d-flex justify-content-between">
                    <a href="{{ url_for('user_view_code_fragment', fragment_id=fragment.fragment_id) }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-2"></i>Cancel
                    </a>
                    <div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i>Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="col-lg-4">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-exclamation-triangle me-2"></i>Edit Mode
                </div>
                <div class="card-body">
                    <p class="small mb-2">You can edit this fragment because it's in <strong>{{ fragment.status or 'draft' }}</strong> status.</p>
                    <p class="small mb-0">Once you submit for review, you won't be able to edit until it's either approved or rejected back to draft.</p>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <i class="bi bi-info-circle me-2"></i>Fragment Info
                </div>
                <div class="card-body">
                    <dl class="row mb-0 small">
                        <dt class="col-5">Fragment ID</dt>
                        <dd class="col-7"><code>{{ fragment.fragment_id[:8] }}...</code></dd>
                        
                        <dt class="col-5">Status</dt>
                        <dd class="col-7">
                            <span class="badge bg-{% if fragment.status == 'draft' %}secondary{% elif fragment.status == 'testing' %}info{% else %}warning{% endif %}">
                                {{ fragment.status or 'draft' }}
                            </span>
                        </dd>
                        
                        <dt class="col-5">Current Version</dt>
                        <dd class="col-7">{{ fragment.version or '1.0.0' }}</dd>
                        
                        <dt class="col-5">Created</dt>
                        <dd class="col-7">{{ fragment.created_at.strftime('%Y-%m-%d') if fragment.created_at else 'N/A' }}</dd>
                        
                        <dt class="col-5">Last Updated</dt>
                        <dd class="col-7">{{ fragment.updated_at.strftime('%Y-%m-%d') if fragment.updated_at else 'N/A' }}</dd>
                    </dl>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <i class="bi bi-diagram-3 me-2"></i>Next Steps
                </div>
                <div class="card-body">
                    <ol class="small mb-0">
                        <li>Make your changes</li>
                        <li>Click <strong>Save Changes</strong></li>
                        <li>Test locally if needed</li>
                        <li>Submit for review when ready</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/shell/shell.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/sql/sql.min.js"></script>
<script>
var modes = {
    'python': 'python',
    'javascript': 'javascript',
    'shell': 'shell',
    'sql': 'sql'
};

var editor = CodeMirror(document.getElementById('codeEditor'), {
    mode: modes['{{ fragment.language or "python" }}'] || 'python',
    theme: 'monokai',
    lineNumbers: true,
    lineWrapping: true,
    indentUnit: 4,
    tabSize: 4,
    indentWithTabs: false,
    value: {{ fragment.code|tojson|safe }}
});

// Sync editor content to hidden textarea
document.querySelector('form').addEventListener('submit', function() {
    document.getElementById('code').value = editor.getValue();
});

// Change language mode
document.getElementById('language').addEventListener('change', function() {
    editor.setOption('mode', modes[this.value] || 'python');
});

// Change theme
function changeTheme() {
    const theme = document.getElementById('themeSelect').value;
    editor.setOption('theme', theme);
}
</script>
{% endblock %}
