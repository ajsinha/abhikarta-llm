{% extends "base.html" %}

{% block title %}{{ org.name }} - AI Organization - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .org-tree {
        padding: 1rem;
    }
    .org-tree-node {
        padding: 0.5rem 1rem;
        margin: 0.25rem 0;
        background: white;
        border-radius: 8px;
        border-left: 4px solid var(--bmo-blue);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .org-tree-children {
        margin-left: 2rem;
        border-left: 2px dashed #dee2e6;
        padding-left: 1rem;
    }
    .stat-card {
        text-align: center;
        padding: 1.5rem;
    }
    .stat-card .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--bmo-blue);
    }
    .stat-card .stat-label {
        font-size: 0.85rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('user_dashboard') }}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('aiorg_list') }}">AI Organizations</a></li>
            <li class="breadcrumb-item active">{{ org.name }}</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2>
                <i class="bi bi-diagram-3 me-2"></i>{{ org.name }}
                {% if org.status.value == 'active' %}
                <span class="badge bg-success">Active</span>
                {% elif org.status.value == 'draft' %}
                <span class="badge bg-warning text-dark">Draft</span>
                {% elif org.status.value == 'paused' %}
                <span class="badge bg-secondary">Paused</span>
                {% endif %}
            </h2>
            <p class="text-muted mb-0">{{ org.description }}</p>
        </div>
        <div class="btn-group">
            {% if 'admin' in roles or 'superadmin' in roles %}
            <a href="{{ url_for('aiorg_designer', org_id=org.org_id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil-square me-1"></i>Edit Design
            </a>
            {% if org.status.value == 'draft' %}
            <button class="btn btn-success" onclick="activateOrg()">
                <i class="bi bi-play-fill me-1"></i>Activate
            </button>
            {% elif org.status.value == 'active' %}
            <button class="btn btn-warning" onclick="pauseOrg()">
                <i class="bi bi-pause-fill me-1"></i>Pause
            </button>
            {% endif %}
            {% endif %}
            <a href="{{ url_for('aiorg_task_create', org_id=org.org_id) }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-1"></i>Submit Task
            </a>
        </div>
    </div>

    <div class="row g-4">
        <!-- Stats -->
        <div class="col-12">
            <div class="row g-3">
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value">{{ stats.node_count or nodes|length }}</div>
                        <div class="stat-label">Total Nodes</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value">{{ stats.total_tasks or 0 }}</div>
                        <div class="stat-label">Total Tasks</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value">{{ stats.task_by_status.get('completed', 0) if stats.task_by_status else 0 }}</div>
                        <div class="stat-label">Completed</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card stat-card">
                        <div class="stat-value">{{ stats.hitl_actions or 0 }}</div>
                        <div class="stat-label">HITL Actions</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Org Tree -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-diagram-3 me-2"></i>Organization Structure</h5>
                    <a href="{{ url_for('aiorg_designer', org_id=org.org_id) }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-pencil me-1"></i>Edit
                    </a>
                </div>
                <div class="card-body org-tree">
                    {% macro render_node(node) %}
                    <div class="org-tree-node">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ node.role_name }}</strong>
                                <span class="badge bg-{{ 'purple' if node.role_type.value == 'executive' else 'primary' if node.role_type.value == 'manager' else 'success' if node.role_type.value == 'analyst' else 'warning' }} ms-2">
                                    {{ node.role_type.value }}
                                </span>
                            </div>
                            {% if node.hitl_config.enabled %}
                            <span class="badge bg-info">HITL</span>
                            {% endif %}
                        </div>
                        {% if node.human_mirror.name %}
                        <small class="text-muted">
                            <i class="bi bi-person me-1"></i>{{ node.human_mirror.name }}
                        </small>
                        {% endif %}
                    </div>
                    {% if node.children %}
                    <div class="org-tree-children">
                        {% for child in node.children %}
                        {{ render_node(child) }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endmacro %}

                    {% if root_node %}
                    {{ render_node(root_node) }}
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-diagram-3 display-4"></i>
                        <p class="mt-2">No nodes configured yet.</p>
                        <a href="{{ url_for('aiorg_designer', org_id=org.org_id) }}" class="btn btn-primary">
                            Design Org Chart
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Tasks -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-list-task me-2"></i>Recent Tasks</h5>
                    <a href="{{ url_for('aiorg_tasks', org_id=org.org_id) }}" class="btn btn-sm btn-outline-secondary">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    {% if tasks %}
                    <div class="list-group list-group-flush">
                        {% for task in tasks[:10] %}
                        <a href="{{ url_for('aiorg_task_detail', org_id=org.org_id, task_id=task.task_id) }}" 
                           class="list-group-item list-group-item-action">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>{{ task.title[:50] }}{% if task.title|length > 50 %}...{% endif %}</strong>
                                    <br>
                                    <small class="text-muted">{{ task.created_at.strftime('%Y-%m-%d %H:%M') if task.created_at else 'N/A' }}</small>
                                </div>
                                <span class="badge bg-{{ 'success' if task.status.value == 'completed' else 'warning' if task.status.value in ['in_progress', 'delegated', 'waiting'] else 'danger' if task.status.value == 'failed' else 'secondary' }}">
                                    {{ task.status.value }}
                                </span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-inbox display-4"></i>
                        <p class="mt-2">No tasks yet.</p>
                        <a href="{{ url_for('aiorg_task_create', org_id=org.org_id) }}" class="btn btn-primary btn-sm">
                            Submit First Task
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="card mt-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Actions</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <a href="{{ url_for('aiorg_task_create', org_id=org.org_id) }}" class="btn btn-outline-primary w-100 py-3">
                        <i class="bi bi-plus-circle display-6 d-block mb-2"></i>
                        Submit New Task
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{{ url_for('aiorg_monitor', org_id=org.org_id) }}" class="btn btn-outline-info w-100 py-3">
                        <i class="bi bi-activity display-6 d-block mb-2"></i>
                        Real-time Monitor
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{{ url_for('aiorg_export', org_id=org.org_id) }}" class="btn btn-outline-secondary w-100 py-3">
                        <i class="bi bi-download display-6 d-block mb-2"></i>
                        Export JSON
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="{{ url_for('aiorg_hitl_dashboard') }}" class="btn btn-outline-warning w-100 py-3">
                        <i class="bi bi-person-check display-6 d-block mb-2"></i>
                        HITL Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Metadata -->
    <div class="card mt-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Details</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted" style="width: 150px;">Organization ID</td>
                            <td><code>{{ org.org_id }}</code></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Event Bus Channel</td>
                            <td><code>{{ org.event_bus_channel }}</code></td>
                        </tr>
                        <tr>
                            <td class="text-muted">Created By</td>
                            <td>{{ org.created_by }}</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-borderless">
                        <tr>
                            <td class="text-muted" style="width: 150px;">Status</td>
                            <td>{{ org.status.value }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Created</td>
                            <td>{{ org.created_at.strftime('%Y-%m-%d %H:%M:%S') if org.created_at else 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">Last Updated</td>
                            <td>{{ org.updated_at.strftime('%Y-%m-%d %H:%M:%S') if org.updated_at else 'N/A' }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Help & Documentation -->
    <div class="card mt-4 bg-light">
        <div class="card-body py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-info-circle text-primary me-2"></i>
                    <span class="text-muted">Need help understanding AI Organizations?</span>
                </div>
                <div>
                    <a href="{{ url_for('help_page', page='glossary') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-book me-1"></i>Glossary
                    </a>
                    <a href="{{ url_for('help_page', page='aiorg') }}" class="btn btn-sm btn-outline-primary ms-2">
                        <i class="bi bi-question-circle me-1"></i>Documentation
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Danger Zone -->
    {% if 'admin' in roles or 'superadmin' in roles %}
    <div class="card mt-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-exclamation-triangle me-2"></i>Danger Zone</h5>
        </div>
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>Delete Organization</strong>
                    <p class="text-muted mb-0 small">Permanently delete this organization and all associated data.</p>
                </div>
                <form method="post" action="{{ url_for('aiorg_delete', org_id=org.org_id) }}" 
                      onsubmit="return confirm('Are you sure you want to delete this organization? This action cannot be undone.');">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-1"></i>Delete Organization
                    </button>
                </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    const orgId = "{{ org.org_id }}";
    
    function activateOrg() {
        fetch(`/api/aiorg/${orgId}/activate`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        });
    }
    
    function pauseOrg() {
        fetch(`/api/aiorg/${orgId}/pause`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        });
    }
</script>
{% endblock %}
