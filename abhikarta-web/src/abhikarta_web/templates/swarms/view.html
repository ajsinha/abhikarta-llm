{% extends "base.html" %}

{% block title %}{{ swarm.name }} - Swarm Details - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item"><a href="{{ url_for('list_swarms') }}">Swarms</a></li>
                    <li class="breadcrumb-item active">{{ swarm.name }}</li>
                </ol>
            </nav>
            <h4 class="mb-0">
                <i class="bi bi-hive me-2 text-warning"></i>{{ swarm.name }}
                {% if is_running %}
                <span class="badge bg-success ms-2">Running</span>
                {% elif swarm.status == 'published' %}
                <span class="badge bg-success ms-2">Published</span>
                {% elif swarm.status == 'pending_review' %}
                <span class="badge bg-info ms-2">Pending Review</span>
                {% elif swarm.status == 'approved' %}
                <span class="badge bg-primary ms-2">Approved</span>
                {% elif swarm.status == 'testing' %}
                <span class="badge bg-warning text-dark ms-2">Testing</span>
                {% elif swarm.status == 'deprecated' %}
                <span class="badge bg-warning ms-2">Deprecated</span>
                {% elif swarm.status == 'archived' %}
                <span class="badge bg-dark ms-2">Archived</span>
                {% else %}
                <span class="badge bg-secondary ms-2">{{ swarm.status|title }}</span>
                {% endif %}
            </h4>
            <p class="text-muted mb-0">{{ swarm.description or 'No description' }}</p>
        </div>
        <div class="btn-group">
            {% if is_running %}
            <form action="{{ url_for('stop_swarm', swarm_id=swarm.swarm_id) }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-danger">
                    <i class="bi bi-stop-circle me-1"></i>Stop
                </button>
            </form>
            {% else %}
            <form action="{{ url_for('start_swarm', swarm_id=swarm.swarm_id) }}" method="POST" class="d-inline">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-play-circle me-1"></i>Start
                </button>
            </form>
            {% endif %}
            <a href="{{ url_for('edit_swarm', swarm_id=swarm.swarm_id) }}" class="btn btn-outline-primary">
                <i class="bi bi-pencil me-1"></i>Edit
            </a>
            <a href="{{ url_for('swarm_designer', swarm_id=swarm.swarm_id) }}" class="btn btn-primary">
                <i class="bi bi-palette me-1"></i>Designer
            </a>
            <a href="{{ url_for('monitor_swarm', swarm_id=swarm.swarm_id) }}" class="btn btn-info">
                <i class="bi bi-activity me-1"></i>Monitor
            </a>
        </div>
    </div>
    
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-8">
            <!-- Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body text-center py-3">
                            <h3 class="text-primary mb-0">{{ swarm.total_executions or 0 }}</h3>
                            <small class="text-muted">Total Runs</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center py-3">
                            <h3 class="text-success mb-0">{{ swarm.successful_executions or 0 }}</h3>
                            <small class="text-muted">Successful</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-danger">
                        <div class="card-body text-center py-3">
                            <h3 class="text-danger mb-0">{{ swarm.failed_executions or 0 }}</h3>
                            <small class="text-muted">Failed</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center py-3">
                            <h3 class="text-info mb-0">{{ swarm.total_events_processed or 0 }}</h3>
                            <small class="text-muted">Events</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Details Card -->
            <div class="card mb-4">
                <div class="card-header bg-bmo">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Swarm Details</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td class="text-muted" width="120">ID</td>
                                    <td><code>{{ swarm.swarm_id }}</code></td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Version</td>
                                    <td>{{ swarm.version or '1.0.0' }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Category</td>
                                    <td><span class="badge bg-info">{{ swarm.category or 'general' }}</span></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless table-sm">
                                <tr>
                                    <td class="text-muted" width="120">Created</td>
                                    <td>{{ swarm.created_at }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Updated</td>
                                    <td>{{ swarm.updated_at }}</td>
                                </tr>
                                <tr>
                                    <td class="text-muted">Created By</td>
                                    <td>{{ swarm.created_by or 'Unknown' }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Agents -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-robot me-2"></i>Agents</h5>
                    <span class="badge bg-primary">{{ agents|length if agents else 0 }} agents</span>
                </div>
                <div class="card-body p-0">
                    <ul class="list-group list-group-flush">
                        {% if agents %}
                            {% for agent in agents %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>{{ agent.agent_name or agent.agent_id }}</strong>
                                    <br><small class="text-muted">Role: {{ agent.role or 'worker' }}</small>
                                </div>
                                <span class="badge bg-secondary">{{ agent.agent_id[:8] }}...</span>
                            </li>
                            {% endfor %}
                        {% else %}
                        <li class="list-group-item text-muted">No agents configured</li>
                        {% endif %}
                    </ul>
                </div>
            </div>

            <!-- Export Options -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-download me-2"></i>Export</h5>
                    <div class="btn-group btn-group-sm">
                        <a href="{{ url_for('export_swarm_json', swarm_id=swarm.swarm_id) }}" class="btn btn-outline-primary">
                            <i class="bi bi-filetype-json me-1"></i>JSON
                        </a>
                        <a href="{{ url_for('export_swarm_python', swarm_id=swarm.swarm_id) }}" class="btn btn-outline-success">
                            <i class="bi bi-filetype-py me-1"></i>Python
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#json-pane">
                                <i class="bi bi-braces me-1"></i>JSON
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#python-pane" id="python-tab">
                                <i class="bi bi-filetype-py me-1"></i>Python SDK
                            </button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="json-pane">
                            <div class="position-relative mt-3">
                                <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" onclick="copyJson()">
                                    <i class="bi bi-clipboard me-1"></i>Copy
                                </button>
                                <pre class="json-viewer" id="jsonContent" style="max-height: 400px; overflow-y: auto;">{{ swarm | tojson(indent=2) }}</pre>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="python-pane">
                            <div class="position-relative mt-3">
                                <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" onclick="copyPython()">
                                    <i class="bi bi-clipboard me-1"></i>Copy
                                </button>
                                <pre class="code-block" id="pythonContent" style="max-height: 400px; overflow-y: auto;"><code class="language-python">Loading...</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="col-lg-4">
            <!-- Status & Actions -->
            <div class="card mb-4">
                <div class="card-header bg-bmo">
                    <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Status & Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if swarm.status == 'draft' %}
                        <div class="alert alert-secondary py-2 mb-2">
                            <i class="bi bi-pencil me-1"></i><strong>Draft</strong>
                            <br><small>Work in progress</small>
                        </div>
                        <button class="btn btn-outline-warning" onclick="changeStatus('testing')">
                            <i class="bi bi-flask me-1"></i> Move to Testing
                        </button>
                        
                        {% elif swarm.status == 'testing' %}
                        <div class="alert alert-warning py-2 mb-2">
                            <i class="bi bi-flask me-1"></i><strong>Testing</strong>
                            <br><small>Under validation</small>
                        </div>
                        <button class="btn btn-outline-info" onclick="changeStatus('pending_review')">
                            <i class="bi bi-eye me-1"></i> Submit for Review
                        </button>
                        <button class="btn btn-outline-secondary" onclick="changeStatus('draft')">
                            <i class="bi bi-arrow-left me-1"></i> Back to Draft
                        </button>
                        
                        {% elif swarm.status == 'pending_review' %}
                        <div class="alert alert-info py-2 mb-2">
                            <i class="bi bi-hourglass-split me-1"></i><strong>Pending Review</strong>
                            <br><small>Awaiting admin approval</small>
                        </div>
                        <button class="btn btn-success" onclick="changeStatus('approved')">
                            <i class="bi bi-check-circle me-1"></i> Approve
                        </button>
                        <button class="btn btn-outline-danger" onclick="changeStatus('testing')">
                            <i class="bi bi-x-circle me-1"></i> Reject
                        </button>
                        <button class="btn btn-outline-secondary" onclick="changeStatus('draft')">
                            <i class="bi bi-arrow-left me-1"></i> Back to Draft
                        </button>
                        
                        {% elif swarm.status == 'approved' %}
                        <div class="alert alert-primary py-2 mb-2">
                            <i class="bi bi-check-circle me-1"></i><strong>Approved</strong>
                            <br><small>Ready to publish</small>
                        </div>
                        <button class="btn btn-success" onclick="changeStatus('published')">
                            <i class="bi bi-rocket me-1"></i> Publish
                        </button>
                        <button class="btn btn-outline-secondary" onclick="changeStatus('draft')">
                            <i class="bi bi-arrow-left me-1"></i> Back to Draft
                        </button>
                        
                        {% elif swarm.status == 'published' %}
                        <div class="alert alert-success py-2 mb-2">
                            <i class="bi bi-globe me-1"></i><strong>Published</strong>
                            <br><small>Available for use</small>
                        </div>
                        <button class="btn btn-outline-warning" onclick="changeStatus('deprecated')">
                            <i class="bi bi-archive me-1"></i> Deprecate
                        </button>
                        
                        {% elif swarm.status == 'deprecated' %}
                        <div class="alert alert-warning py-2 mb-2">
                            <i class="bi bi-exclamation-triangle me-1"></i><strong>Deprecated</strong>
                            <br><small>No longer recommended</small>
                        </div>
                        <button class="btn btn-outline-success" onclick="changeStatus('published')">
                            <i class="bi bi-arrow-up me-1"></i> Re-publish
                        </button>
                        <button class="btn btn-outline-danger" onclick="changeStatus('archived')">
                            <i class="bi bi-archive me-1"></i> Archive
                        </button>
                        
                        {% elif swarm.status == 'archived' %}
                        <div class="alert alert-dark py-2 mb-2">
                            <i class="bi bi-archive me-1"></i><strong>Archived</strong>
                        </div>
                        <button class="btn btn-outline-primary" onclick="changeStatus('draft')">
                            <i class="bi bi-arrow-counterclockwise me-1"></i> Restore to Draft
                        </button>
                        {% endif %}
                        
                        <hr class="my-2">
                        <button class="btn btn-outline-danger" onclick="deleteSwarm()">
                            <i class="bi bi-trash me-1"></i> Delete Swarm
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tags -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-tags me-2"></i>Tags</h5>
                </div>
                <div class="card-body">
                    {% if swarm.tags %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for tag in swarm.tags %}
                        <span class="badge bg-secondary">{{ tag }}</span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">No tags</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Test -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Quick Test</h5>
                </div>
                <div class="card-body">
                    {% if is_running %}
                    <form id="test-form">
                        <div class="mb-3">
                            <label class="form-label">Enter a query:</label>
                            <textarea class="form-control" id="test-query" rows="3" placeholder="Ask something..."></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-play me-1"></i>Execute
                        </button>
                    </form>
                    <div id="test-result" class="mt-3" style="display: none;">
                        <label class="form-label">Result:</label>
                        <pre id="test-output" class="bg-light p-2 rounded" style="max-height: 200px; overflow-y: auto;"></pre>
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">Start the swarm to test queries.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('python-tab')?.addEventListener('shown.bs.tab', loadPythonCode);

function loadPythonCode() {
    const container = document.querySelector('#pythonContent code');
    if (container.textContent !== 'Loading...') return;
    
    $.get('/api/swarms/{{ swarm.swarm_id }}/python', function(data) {
        container.textContent = data;
        if (typeof hljs !== 'undefined') hljs.highlightElement(container);
    }).fail(function() {
        container.textContent = '# Error loading Python code';
    });
}

function copyJson() {
    navigator.clipboard.writeText(document.getElementById('jsonContent').textContent)
        .then(() => showToast('JSON copied', 'success'))
        .catch(() => showToast('Failed to copy', 'error'));
}

function copyPython() {
    navigator.clipboard.writeText(document.querySelector('#pythonContent code').textContent)
        .then(() => showToast('Python code copied', 'success'))
        .catch(() => showToast('Failed to copy', 'error'));
}

function changeStatus(newStatus) {
    if (!confirm(`Change swarm status to "${newStatus}"?`)) return;
    
    $.ajax({
        url: '/api/swarms/{{ swarm.swarm_id }}/status',
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ status: newStatus }),
        success: function() {
            showToast('Status updated', 'success');
            location.reload();
        },
        error: function(xhr) {
            showToast('Error: ' + (xhr.responseJSON?.error || 'Failed'), 'error');
        }
    });
}

function deleteSwarm() {
    if (!confirm('Delete this swarm? This cannot be undone.')) return;
    
    $.ajax({
        url: '/api/swarms/{{ swarm.swarm_id }}',
        method: 'DELETE',
        success: function() {
            window.location.href = '{{ url_for("list_swarms") }}';
        },
        error: function() {
            showToast('Error deleting swarm', 'error');
        }
    });
}

// Quick test form
$('#test-form').on('submit', function(e) {
    e.preventDefault();
    
    const query = $('#test-query').val().trim();
    if (!query) return;
    
    $.ajax({
        url: '{{ url_for("execute_swarm", swarm_id=swarm.swarm_id) }}',
        method: 'POST',
        data: { query: query },
        success: function(response) {
            $('#test-result').show();
            $('#test-output').text(JSON.stringify(response, null, 2));
        },
        error: function() {
            $('#test-result').show();
            $('#test-output').text('Error executing query');
        }
    });
});
</script>
{% endblock %}
